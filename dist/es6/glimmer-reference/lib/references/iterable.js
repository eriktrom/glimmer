import { LinkedList, ListNode, dict, intern, symbol } from 'glimmer-util';
import UpdatableReference from './root';
export const REFERENCE_ITERATOR = symbol("reference-iterator");
class ListItem extends ListNode {
    constructor(value, key) {
        super(value);
        this.handled = true;
        this.key = key;
    }
    handle(value) {
        this.handled = true;
        this.value.update(value);
    }
}
export class ListManager {
    /* tslint:enable:no-unused-variable */
    constructor(array, keyPath) {
        /* tslint:disable:no-unused-variable */
        this.map = dict();
        this.list = new LinkedList();
        this.array = array;
        this.keyPath = keyPath;
    }
    iterator(target) {
        let { array, map, list, keyPath } = this;
        let keyFor;
        if (keyPath === '@index') {
            keyFor = (_, index) => {
                return String(index);
            };
        }
        else {
            keyFor = (item) => {
                return intern(item[keyPath]);
            };
        }
        return new ListIterator({ array: array.value(), keyFor, target, map, list });
    }
    sync(target) {
        let iterator = this.iterator(target);
        while (!iterator.next())
            ;
    }
}
var Phase;
(function (Phase) {
    Phase[Phase["FirstAppend"] = 0] = "FirstAppend";
    Phase[Phase["Append"] = 1] = "Append";
    Phase[Phase["Prune"] = 2] = "Prune";
    Phase[Phase["Done"] = 3] = "Done";
})(Phase || (Phase = {}));
export class ListIterator {
    constructor({ array, keyFor, target, map, list }) {
        /* tslint:disable:no-unused-variable */
        this.candidates = dict();
        this.arrayPosition = 0;
        this.phase = Phase.Append;
        this.array = array;
        this.keyFor = keyFor;
        this.target = target;
        this.map = map;
        this.list = list;
        if (list.isEmpty()) {
            this.phase = Phase.FirstAppend;
        }
        else {
            this.phase = Phase.Append;
        }
        this.listPosition = list.head();
    }
    advanceToKey(key) {
        let { listPosition, candidates, list } = this;
        let seek = listPosition;
        while (seek && seek.key !== key) {
            candidates[seek.key] = seek;
            seek = list.nextNode(seek);
        }
        this.listPosition = seek && list.nextNode(seek);
    }
    next() {
        while (true) {
            let handled = false;
            switch (this.phase) {
                case Phase.FirstAppend:
                    if (this.array.length <= this.arrayPosition) {
                        this.startPrune();
                    }
                    else {
                        handled = this.nextInitialAppend();
                    }
                    break;
                case Phase.Append:
                    handled = this.nextAppend();
                    break;
                case Phase.Prune:
                    this.nextPrune();
                    break;
                case Phase.Done:
                    this.nextDone();
                    return true;
            }
            if (handled)
                return false;
        }
    }
    nextInitialAppend() {
        let { array, arrayPosition, keyFor, listPosition, map } = this;
        let item = array[this.arrayPosition++];
        if (item === null || item === undefined)
            return;
        let key = keyFor(item, arrayPosition);
        this.nextInsert(map, listPosition, key, item);
        return true;
    }
    nextAppend() {
        let { keyFor, array, listPosition, arrayPosition, map } = this;
        if (array.length <= arrayPosition) {
            this.startPrune();
            return;
        }
        let item = array[this.arrayPosition++];
        if (item === null || item === undefined)
            return;
        let key = keyFor(item, arrayPosition);
        if (listPosition && listPosition.key === key) {
            this.nextRetain(listPosition, key, item);
            return false;
        }
        else if (map[key]) {
            this.nextMove(map, listPosition, key, item);
            return false;
        }
        else {
            this.nextInsert(map, listPosition, key, item);
            return true;
        }
    }
    nextRetain(current, key, item) {
        current.handle(item);
        this.listPosition = this.list.nextNode(current);
        this.target.retain(key, item);
    }
    nextMove(map, current, key, item) {
        let { candidates, list, target } = this;
        let found = map[key];
        found.handle(item);
        if (candidates[key]) {
            list.remove(found);
            list.insertBefore(found, current);
            target.move(found.key, found.value, current ? current.key : null);
        }
        else {
            this.advanceToKey(key);
        }
    }
    nextInsert(map, current, key, item) {
        let { list, target } = this;
        let reference = new UpdatableReference(item);
        let node = map[key] = new ListItem(reference, key);
        list.append(node);
        target.insert(node.key, node.value, current ? current.key : null);
    }
    startPrune() {
        this.phase = Phase.Prune;
        this.listPosition = this.list.head();
        return true;
    }
    nextPrune() {
        let { list, target } = this;
        if (this.listPosition === null) {
            this.phase = Phase.Done;
            return;
        }
        let node = this.listPosition;
        this.listPosition = list.nextNode(node);
        if (node.handled) {
            node.handled = false;
            return;
        }
        else {
            list.remove(node);
            delete this.map[node.key];
            target.delete(node.key);
            return;
        }
    }
    nextDone() {
        this.target.done();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlcmFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnbGltbWVyLXJlZmVyZW5jZS9saWIvcmVmZXJlbmNlcy9pdGVyYWJsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQXdCLElBQUksRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sY0FBYztPQUV4RixrQkFBa0IsTUFBTSxRQUFRO0FBRXZDLGFBQWEsa0JBQWtCLEdBQVcsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFVdkUsdUJBQXVCLFFBQVE7SUFJN0IsWUFBWSxLQUF5QixFQUFFLEdBQW1CO1FBQ3hELE1BQU0sS0FBSyxDQUFDLENBQUM7UUFIUixZQUFPLEdBQVksSUFBSSxDQUFDO1FBSTdCLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxNQUFNLENBQUMsS0FBVTtRQUNmLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzNCLENBQUM7QUFDSCxDQUFDO0FBRUQ7SUFPRSxzQ0FBc0M7SUFFdEMsWUFBWSxLQUFvQixFQUFFLE9BQXVCO1FBTHpELHVDQUF1QztRQUMvQixRQUFHLEdBQUcsSUFBSSxFQUFZLENBQUM7UUFDdkIsU0FBSSxHQUFHLElBQUksVUFBVSxFQUFZLENBQUM7UUFJeEMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDekIsQ0FBQztJQUVELFFBQVEsQ0FBQyxNQUFvQjtRQUMzQixJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBRXpDLElBQUksTUFBTSxDQUFDO1FBRVgsRUFBRSxDQUFDLENBQUMsT0FBTyxLQUFLLFFB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SUFBSSxDQUFDLEdBQUcsQ0FBUyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDeEIsTUFBTSxDQUFDO1FBQ1QsQ0FBQztJQUNILENBQUM7SUFFTyxRQUFRO1FBQ2QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNyQixDQUFDO0FBQ0gsQ0FBQztBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTGlua2VkTGlzdCwgTGlzdE5vZGUsIEludGVybmVkU3RyaW5nLCBEaWN0LCBkaWN0LCBpbnRlcm4sIHN5bWJvbCB9IGZyb20gJ2dsaW1tZXItdXRpbCc7XG5pbXBvcnQgeyBSb290UmVmZXJlbmNlIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IFVwZGF0YWJsZVJlZmVyZW5jZSBmcm9tICcuL3Jvb3QnO1xuXG5leHBvcnQgY29uc3QgUkVGRVJFTkNFX0lURVJBVE9SOiBzdHJpbmcgPSBzeW1ib2woXCJyZWZlcmVuY2UtaXRlcmF0b3JcIik7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTGlzdERlbGVnYXRlIHtcbiAgcmV0YWluKGtleTogSW50ZXJuZWRTdHJpbmcsIGl0ZW06IFJvb3RSZWZlcmVuY2UpO1xuICBpbnNlcnQoa2V5OiBJbnRlcm5lZFN0cmluZywgaXRlbTogUm9vdFJlZmVyZW5jZSwgYmVmb3JlOiBJbnRlcm5lZFN0cmluZyk7XG4gIG1vdmUoa2V5OiBJbnRlcm5lZFN0cmluZywgaXRlbTogUm9vdFJlZmVyZW5jZSwgYmVmb3JlOiBJbnRlcm5lZFN0cmluZyk7XG4gIGRlbGV0ZShrZXk6IEludGVybmVkU3RyaW5nKTtcbiAgZG9uZSgpO1xufVxuXG5jbGFzcyBMaXN0SXRlbSBleHRlbmRzIExpc3ROb2RlPFVwZGF0YWJsZVJlZmVyZW5jZT4ge1xuICBwdWJsaWMga2V5OiBJbnRlcm5lZFN0cmluZztcbiAgcHVibGljIGhhbmRsZWQ6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIGNvbnN0cnVjdG9yKHZhbHVlOiBVcGRhdGFibGVSZWZlcmVuY2UsIGtleTogSW50ZXJuZWRTdHJpbmcpIHtcbiAgICBzdXBlcih2YWx1ZSk7XG4gICAgdGhpcy5rZXkgPSBrZXk7XG4gIH1cblxuICBoYW5kbGUodmFsdWU6IGFueSkge1xuICAgIHRoaXMuaGFuZGxlZCA9IHRydWU7XG4gICAgdGhpcy52YWx1ZS51cGRhdGUodmFsdWUpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBMaXN0TWFuYWdlciB7XG4gIHByaXZhdGUgYXJyYXk6IFJvb3RSZWZlcmVuY2U7XG4gIHByaXZhdGUga2V5UGF0aDogSW50ZXJuZWRTdHJpbmc7XG5cbiAgLyogdHNsaW50OmRpc2FibGU6bm8tdW51c2VkLXZhcmlhYmxlICovXG4gIHByaXZhdGUgbWFwID0gZGljdDxMaXN0SXRlbT4oKTtcbiAgcHJpdmF0ZSBsaXN0ID0gbmV3IExpbmtlZExpc3Q8TGlzdEl0ZW0+KCk7XG4gIC8qIHRzbGludDplbmFibGU6bm8tdW51c2VkLXZhcmlhYmxlICovXG5cbiAgY29uc3RydWN0b3IoYXJyYXk6IFJvb3RSZWZlcmVuY2UsIGtleVBhdGg6IEludGVybmVkU3RyaW5nKSB7XG4gICAgdGhpcy5hcnJheSA9IGFycmF5O1xuICAgIHRoaXMua2V5UGF0aCA9IGtleVBhdGg7XG4gIH1cblxuICBpdGVyYXRvcih0YXJnZXQ6IExpc3REZWxlZ2F0ZSk6IExpc3RJdGVyYXRvciB7XG4gICAgbGV0IHsgYXJyYXksIG1hcCwgbGlzdCwga2V5UGF0aCB9ID0gdGhpcztcblxuICAgIGxldCBrZXlGb3I7XG5cbiAgICBpZiAoa2V5UGF0aCA9PT0gJ0BpbmRleCcpIHtcbiAgICAgIGtleUZvciA9IChfLCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgIHJldHVybiBTdHJpbmcoaW5kZXgpO1xuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAga2V5Rm9yID0gKGl0ZW06IEludGVybmVkU3RyaW5nKSA9PiB7XG4gICAgICAgIHJldHVybiBpbnRlcm4oaXRlbVs8c3RyaW5nPmtleVBhdGhdKTtcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBMaXN0SXRlcmF0b3IoeyBhcnJheTogYXJyYXkudmFsdWUoKSwga2V5Rm9yLCB0YXJnZXQsIG1hcCwgbGlzdCB9KTtcbiAgfVxuXG4gIHN5bmModGFyZ2V0OiBMaXN0RGVsZWdhdGUpIHtcbiAgICBsZXQgaXRlcmF0b3IgPSB0aGlzLml0ZXJhdG9yKHRhcmdldCk7XG4gICAgd2hpbGUgKCFpdGVyYXRvci5uZXh0KCkpO1xuICB9XG59XG5cbmludGVyZmFjZSBJdGVyYXRvck9wdGlvbnMge1xuICBhcnJheTogYW55W107XG4gIGtleUZvcjogKG9iajogYW55LCBpbmRleDogbnVtYmVyKSA9PiBJbnRlcm5lZFN0cmluZztcbiAgdGFyZ2V0OiBMaXN0RGVsZWdhdGU7XG4gIG1hcDogRGljdDxMaXN0SXRlbT47XG4gIGxpc3Q6IExpbmtlZExpc3Q8TGlzdEl0ZW0+O1xufVxuXG5lbnVtIFBoYXNlIHtcbiAgRmlyc3RBcHBlbmQsXG4gIEFwcGVuZCxcbiAgUHJ1bmUsXG4gIERvbmVcbn1cblxuZXhwb3J0IGNsYXNzIExpc3RJdGVyYXRvciB7XG4gIC8qIHRzbGludDpkaXNhYmxlOm5vLXVudXNlZC12YXJpYWJsZSAqL1xuICBwcml2YXRlIGNhbmRpZGF0ZXMgPSBkaWN0PExpc3RJdGVtPigpO1xuICAvKiB0c2xpbnQ6ZW5hYmxlOm5vLXVudXNlZC12YXJpYWJsZSovXG4gIHByaXZhdGUgYXJyYXk6IGFueVtdO1xuICBwcml2YXRlIGtleUZvcjogKG9iaiwgaW5kZXg6IG51bWJlcikgPT4gSW50ZXJuZWRTdHJpbmc7XG4gIHByaXZhdGUgdGFyZ2V0OiBMaXN0RGVsZWdhdGU7XG5cbiAgcHJpdmF0ZSBtYXA6IERpY3Q8TGlzdEl0ZW0+O1xuICBwcml2YXRlIGxpc3Q6IExpbmtlZExpc3Q8TGlzdEl0ZW0+O1xuXG4gIHByaXZhdGUgYXJyYXlQb3NpdGlvbiA9IDA7XG4gIHByaXZhdGUgbGlzdFBvc2l0aW9uOiBMaXN0SXRlbTtcbiAgcHJpdmF0ZSBwaGFzZTogUGhhc2UgPSBQaGFzZS5BcHBlbmQ7XG5cbiAgY29uc3RydWN0b3IoeyBhcnJheSwga2V5Rm9yLCB0YXJnZXQsIG1hcCwgbGlzdCB9OiBJdGVyYXRvck9wdGlvbnMpIHtcbiAgICB0aGlzLmFycmF5ID0gYXJyYXk7XG4gICAgdGhpcy5rZXlGb3IgPSBrZXlGb3I7XG4gICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7XG4gICAgdGhpcy5tYXAgPSBtYXA7XG4gICAgdGhpcy5saXN0ID0gbGlzdDtcblxuICAgIGlmIChsaXN0LmlzRW1wdHkoKSkge1xuICAgICAgdGhpcy5waGFzZSA9IFBoYXNlLkZpcnN0QXBwZW5kO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnBoYXNlID0gUGhhc2UuQXBwZW5kO1xuICAgIH1cblxuICAgIHRoaXMubGlzdFBvc2l0aW9uID0gbGlzdC5oZWFkKCk7XG4gIH1cblxuICBhZHZhbmNlVG9LZXkoa2V5OiBJbnRlcm5lZFN0cmluZykge1xuICAgIGxldCB7IGxpc3RQb3NpdGlvbiwgY2FuZGlkYXRlcywgbGlzdCB9ID0gdGhpcztcblxuICAgIGxldCBzZWVrID0gbGlzdFBvc2l0aW9uO1xuXG4gICAgd2hpbGUgKHNlZWsgJiYgc2Vlay5rZXkgIT09IGtleSkge1xuICAgICAgY2FuZGlkYXRlc1s8c3RyaW5nPnNlZWsua2V5XSA9IHNlZWs7XG4gICAgICBzZWVrID0gbGlzdC5uZXh0Tm9kZShzZWVrKTtcbiAgICB9XG5cbiAgICB0aGlzLmxpc3RQb3NpdGlvbiA9IHNlZWsgJiYgbGlzdC5uZXh0Tm9kZShzZWVrKTtcbiAgfVxuXG4gIG5leHQoKTogYm9vbGVhbiB7XG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIGxldCBoYW5kbGVkID0gZmFsc2U7XG4gICAgICBzd2l0Y2ggKHRoaXMucGhhc2UpIHtcbiAgICAgICAgY2FzZSBQaGFzZS5GaXJzdEFwcGVuZDpcbiAgICAgICAgICBpZiAodGhpcy5hcnJheS5sZW5ndGggPD0gdGhpcy5hcnJheVBvc2l0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0UHJ1bmUoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaGFuZGxlZCA9IHRoaXMubmV4dEluaXRpYWxBcHBlbmQoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgUGhhc2UuQXBwZW5kOiBoYW5kbGVkID0gdGhpcy5uZXh0QXBwZW5kKCk7IGJyZWFrO1xuICAgICAgICBjYXNlIFBoYXNlLlBydW5lOiB0aGlzLm5leHRQcnVuZSgpOyBicmVhaztcbiAgICAgICAgY2FzZSBQaGFzZS5Eb25lOiB0aGlzLm5leHREb25lKCk7IHJldHVybiB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoaGFuZGxlZCkgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbmV4dEluaXRpYWxBcHBlbmQoKTogYm9vbGVhbiB7XG4gICAgbGV0IHsgYXJyYXksIGFycmF5UG9zaXRpb24sIGtleUZvciwgbGlzdFBvc2l0aW9uLCBtYXAgfSA9IHRoaXM7XG5cbiAgICBsZXQgaXRlbSA9IGFycmF5W3RoaXMuYXJyYXlQb3NpdGlvbisrXTtcblxuICAgIGlmIChpdGVtID09PSBudWxsIHx8IGl0ZW0gPT09IHVuZGVmaW5lZCkgcmV0dXJuO1xuXG4gICAgbGV0IGtleSA9IGtleUZvcihpdGVtLCBhcnJheVBvc2l0aW9uKTtcbiAgICB0aGlzLm5leHRJbnNlcnQobWFwLCBsaXN0UG9zaXRpb24sIGtleSwgaXRlbSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIG5leHRBcHBlbmQoKTogYm9vbGVhbiB7XG4gICAgbGV0IHsga2V5Rm9yLCBhcnJheSwgbGlzdFBvc2l0aW9uLCBhcnJheVBvc2l0aW9uLCBtYXAgfSA9IHRoaXM7XG5cbiAgICBpZiAoYXJyYXkubGVuZ3RoIDw9IGFycmF5UG9zaXRpb24pIHtcbiAgICAgIHRoaXMuc3RhcnRQcnVuZSgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBpdGVtID0gYXJyYXlbdGhpcy5hcnJheVBvc2l0aW9uKytdO1xuXG4gICAgaWYgKGl0ZW0gPT09IG51bGwgfHwgaXRlbSA9PT0gdW5kZWZpbmVkKSByZXR1cm47XG5cbiAgICBsZXQga2V5ID0ga2V5Rm9yKGl0ZW0sIGFycmF5UG9zaXRpb24pO1xuXG4gICAgaWYgKGxpc3RQb3NpdGlvbiAmJiBsaXN0UG9zaXRpb24ua2V5ID09PSBrZXkpIHtcbiAgICAgIHRoaXMubmV4dFJldGFpbihsaXN0UG9zaXRpb24sIGtleSwgaXRlbSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSBlbHNlIGlmIChtYXBbPHN0cmluZz5rZXldKSB7XG4gICAgICB0aGlzLm5leHRNb3ZlKG1hcCwgbGlzdFBvc2l0aW9uLCBrZXksIGl0ZW0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm5leHRJbnNlcnQobWFwLCBsaXN0UG9zaXRpb24sIGtleSwgaXRlbSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG5leHRSZXRhaW4oY3VycmVudDogTGlzdEl0ZW0sIGtleTogSW50ZXJuZWRTdHJpbmcsIGl0ZW06IGFueSkge1xuICAgIGN1cnJlbnQuaGFuZGxlKGl0ZW0pO1xuICAgIHRoaXMubGlzdFBvc2l0aW9uID0gdGhpcy5saXN0Lm5leHROb2RlKGN1cnJlbnQpO1xuICAgIHRoaXMudGFyZ2V0LnJldGFpbihrZXksIGl0ZW0pO1xuICB9XG5cbiAgcHJpdmF0ZSBuZXh0TW92ZShtYXA6IERpY3Q8TGlzdEl0ZW0+LCBjdXJyZW50OiBMaXN0SXRlbSwga2V5OiBJbnRlcm5lZFN0cmluZywgaXRlbTogYW55KSB7XG4gICAgbGV0IHsgY2FuZGlkYXRlcywgbGlzdCwgdGFyZ2V0IH0gPSB0aGlzO1xuICAgIGxldCBmb3VuZCA9IG1hcFs8c3RyaW5nPmtleV07XG4gICAgZm91bmQuaGFuZGxlKGl0ZW0pO1xuXG4gICAgaWYgKGNhbmRpZGF0ZXNbPHN0cmluZz5rZXldKSB7XG4gICAgICBsaXN0LnJlbW92ZShmb3VuZCk7XG4gICAgICBsaXN0Lmluc2VydEJlZm9yZShmb3VuZCwgY3VycmVudCk7XG4gICAgICB0YXJnZXQubW92ZShmb3VuZC5rZXksIGZvdW5kLnZhbHVlLCBjdXJyZW50ID8gY3VycmVudC5rZXkgOiBudWxsKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hZHZhbmNlVG9LZXkoa2V5KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG5leHRJbnNlcnQobWFwOiBEaWN0PExpc3RJdGVtPiwgY3VycmVudDogTGlzdEl0ZW0sIGtleTogSW50ZXJuZWRTdHJpbmcsIGl0ZW06IGFueSkge1xuICAgIGxldCB7IGxpc3QsIHRhcmdldCB9ID0gdGhpcztcblxuICAgIGxldCByZWZlcmVuY2UgPSBuZXcgVXBkYXRhYmxlUmVmZXJlbmNlKGl0ZW0pO1xuICAgIGxldCBub2RlID0gbWFwWzxzdHJpbmc+a2V5XSA9IG5ldyBMaXN0SXRlbShyZWZlcmVuY2UsIGtleSk7XG4gICAgbGlzdC5hcHBlbmQobm9kZSk7XG4gICAgdGFyZ2V0Lmluc2VydChub2RlLmtleSwgbm9kZS52YWx1ZSwgY3VycmVudCA/IGN1cnJlbnQua2V5IDogbnVsbCk7XG4gIH1cblxuICBwcml2YXRlIHN0YXJ0UHJ1bmUoKTogYm9vbGVhbiB7XG4gICAgdGhpcy5waGFzZSA9IFBoYXNlLlBydW5lO1xuICAgIHRoaXMubGlzdFBvc2l0aW9uID0gdGhpcy5saXN0LmhlYWQoKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgbmV4dFBydW5lKCkge1xuICAgIGxldCB7IGxpc3QsIHRhcmdldCB9ID0gdGhpcztcblxuICAgIGlmICh0aGlzLmxpc3RQb3NpdGlvbiA9PT0gbnVsbCkge1xuICAgICAgdGhpcy5waGFzZSA9IFBoYXNlLkRvbmU7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IG5vZGUgPSB0aGlzLmxpc3RQb3NpdGlvbjtcbiAgICB0aGlzLmxpc3RQb3NpdGlvbiA9IGxpc3QubmV4dE5vZGUobm9kZSk7XG5cbiAgICBpZiAobm9kZS5oYW5kbGVkKSB7XG4gICAgICBub2RlLmhhbmRsZWQgPSBmYWxzZTtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2Uge1xuICAgICAgbGlzdC5yZW1vdmUobm9kZSk7XG4gICAgICBkZWxldGUgdGhpcy5tYXBbPHN0cmluZz5ub2RlLmtleV07XG4gICAgICB0YXJnZXQuZGVsZXRlKG5vZGUua2V5KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG5leHREb25lKCkge1xuICAgIHRoaXMudGFyZ2V0LmRvbmUoKTtcbiAgfVxufVxuIl19