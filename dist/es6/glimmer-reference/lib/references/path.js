import { EMPTY_CACHE } from '../utils';
import { DictSet, dict } from 'glimmer-util';
import Meta from '../meta';
import ForkedReference from './forked';
import { PropertyReference } from './descriptors';
import PushPullReference from './push-pull';
class UnchainFromPath {
    constructor(set, child) {
        this.set = set;
        this.child = child;
    }
    destroy() {
        this.set.delete(this.child);
    }
}
export class PathReference extends PushPullReference {
    constructor(parent, property) {
        super();
        this.cache = EMPTY_CACHE;
        this.inner = null;
        this.chains = null;
        this.notifyChildren = null;
        this.lastParentValue = EMPTY_CACHE;
        this._guid = null;
        this.parent = parent;
        this.property = property;
    }
    isDirty() { return this.cache === EMPTY_CACHE || (this.inner && this.inner.isDirty()); }
    value() {
        if (!this.isDirty())
            return this.cache;
        let { lastParentValue, property, inner } = this;
        let parentValue = this._parentValue();
        if (parentValue === null || parentValue === undefined) {
            return (this.cache = undefined);
        }
        if (lastParentValue === parentValue) {
            inner = this.inner;
        }
        else {
            let ReferenceType = typeof parentValue === 'object' ? Meta.for(parentValue).referenceTypeFor(property) : PropertyReference;
            inner = this.inner = new ReferenceType(parentValue, property, this);
        }
        // if (typeof parentValue === 'object') {
        //   Meta.for(parentValue).addReference(property, this);
        // }
        return (this.cache = inner.value());
    }
    notify() {
        // this._notify();
        super.notify();
    }
    get(prop) {
        let chains = this._getChains();
        if (prop in chains)
            return chains[prop];
        return (chains[prop] = new PathReference(this, prop));
    }
    chain(child) {
        let notifySet = this._getNotifyChildren();
        notifySet.add(child);
        return new UnchainFromPath(notifySet, child);
    }
    fork() {
        return new ForkedReference(this);
    }
    label() {
        return '[reference Direct]';
    }
    _getNotifyChildren() {
        if (this.notifyChildren)
            return this.notifyChildren;
        return (this.notifyChildren = new DictSet());
    }
    _getChains() {
        if (this.chains)
            return this.chains;
        return (this.chains = dict());
    }
    _parentValue() {
        var parent = this.parent.value();
        this.lastParentValue = parent;
        return parent;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdsaW1tZXItcmVmZXJlbmNlL2xpYi9yZWZlcmVuY2VzL3BhdGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ik9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxVQUFVO09BQy9CLEVBQWtCLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxjQUFjO09BQ3JELElBQUksTUFBTSxTQUFTO09BQ25CLGVBQWUsTUFBTSxVQUFVO09BQy9CLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxlQUFlO09BQzFDLGlCQUFpQixNQUFNLGFBQWE7QUFJM0M7SUFJRSxZQUFZLEdBQXFDLEVBQUUsS0FBOEI7UUFDL0UsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDZixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUNyQixDQUFDO0lBRUQsT0FBTztRQUNMLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM5QixDQUFDO0FBQ0gsQ0FBQztBQUVELG1DQUFtQyxpQkFBaUI7SUFVbEQsWUFBWSxNQUFzQixFQUFFLFFBQXdCO1FBQzFELE9BQU8sQ0FBQztRQVJBLFVBQUssR0FBUSxXQUFXLENBQUM7UUFDM0IsVUFBSyxHQUFjLElBQUksQ0FBQztRQUN4QixXQUFNLEdBQXdCLElBQUksQ0FBQztRQUNuQyxtQkFBYyxHQUEyQixJQUFJLENBQUM7UUFDOUMsb0JBQWUsR0FBUSxXQUFXLENBQUM7UUFDcEMsVUFBSyxHQUFHLElBQUksQ0FBQztRQUlsQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUMzQixDQUFDO0lBRUQsT0FBTyxLQUFjLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxLQUFLLFdBQVcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUss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TSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxlQUFlLEdBQUcsTUFBTSxDQUFDO1FBQzlCLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDaEIsQ0FBQztBQUNILENBQUM7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVNUFRZX0NBQ0hFIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgSW50ZXJuZWRTdHJpbmcsIERpY3RTZXQsIGRpY3QgfSBmcm9tICdnbGltbWVyLXV0aWwnO1xuaW1wb3J0IE1ldGEgZnJvbSAnLi4vbWV0YSc7XG5pbXBvcnQgRm9ya2VkUmVmZXJlbmNlIGZyb20gJy4vZm9ya2VkJztcbmltcG9ydCB7IFByb3BlcnR5UmVmZXJlbmNlIH0gZnJvbSAnLi9kZXNjcmlwdG9ycyc7XG5pbXBvcnQgUHVzaFB1bGxSZWZlcmVuY2UgZnJvbSAnLi9wdXNoLXB1bGwnO1xuaW1wb3J0IHsgUGF0aFJlZmVyZW5jZSBhcyBJUGF0aFJlZmVyZW5jZSwgUmVmZXJlbmNlLCBEZXN0cm95YWJsZSB9IGZyb20gJ2dsaW1tZXItcmVmZXJlbmNlJztcbmltcG9ydCB7IERpY3QsIEhhc0d1aWQgfSBmcm9tICdnbGltbWVyLXV0aWwnO1xuXG5jbGFzcyBVbmNoYWluRnJvbVBhdGgge1xuICBwcml2YXRlIHNldDogRGljdFNldDxQYXRoUmVmZXJlbmNlICYgSGFzR3VpZD47XG4gIHByaXZhdGUgY2hpbGQ6IFBhdGhSZWZlcmVuY2UgJiBIYXNHdWlkO1xuXG4gIGNvbnN0cnVjdG9yKHNldDogRGljdFNldDxQYXRoUmVmZXJlbmNlICYgSGFzR3VpZD4sIGNoaWxkOiBQYXRoUmVmZXJlbmNlICYgSGFzR3VpZCkge1xuICAgIHRoaXMuc2V0ID0gc2V0O1xuICAgIHRoaXMuY2hpbGQgPSBjaGlsZDtcbiAgfVxuXG4gIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5zZXQuZGVsZXRlKHRoaXMuY2hpbGQpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQYXRoUmVmZXJlbmNlIGV4dGVuZHMgUHVzaFB1bGxSZWZlcmVuY2UgaW1wbGVtZW50cyBJUGF0aFJlZmVyZW5jZSwgSGFzR3VpZCB7XG4gIHByaXZhdGUgcGFyZW50OiBJUGF0aFJlZmVyZW5jZTtcbiAgcHJpdmF0ZSBwcm9wZXJ0eTogSW50ZXJuZWRTdHJpbmc7XG4gIHByb3RlY3RlZCBjYWNoZTogYW55ID0gRU1QVFlfQ0FDSEU7XG4gIHByaXZhdGUgaW5uZXI6IFJlZmVyZW5jZSA9IG51bGw7XG4gIHByaXZhdGUgY2hhaW5zOiBEaWN0PFBhdGhSZWZlcmVuY2U+ID0gbnVsbDtcbiAgcHJpdmF0ZSBub3RpZnlDaGlsZHJlbjogRGljdFNldDxQYXRoUmVmZXJlbmNlPiA9IG51bGw7XG4gIHByaXZhdGUgbGFzdFBhcmVudFZhbHVlOiBhbnkgPSBFTVBUWV9DQUNIRTtcbiAgcHVibGljIF9ndWlkID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihwYXJlbnQ6IElQYXRoUmVmZXJlbmNlLCBwcm9wZXJ0eTogSW50ZXJuZWRTdHJpbmcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMucGFyZW50ID0gcGFyZW50O1xuICAgIHRoaXMucHJvcGVydHkgPSBwcm9wZXJ0eTtcbiAgfVxuXG4gIGlzRGlydHkoKTogYm9vbGVhbiB7IHJldHVybiB0aGlzLmNhY2hlID09PSBFTVBUWV9DQUNIRSB8fCAodGhpcy5pbm5lciAmJiB0aGlzLmlubmVyLmlzRGlydHkoKSk7IH1cblxuICB2YWx1ZSgpOiBhbnkge1xuICAgIGlmICghdGhpcy5pc0RpcnR5KCkpIHJldHVybiB0aGlzLmNhY2hlO1xuICAgIGxldCB7IGxhc3RQYXJlbnRWYWx1ZSwgcHJvcGVydHksIGlubmVyIH0gPSB0aGlzO1xuICAgIGxldCBwYXJlbnRWYWx1ZSA9IHRoaXMuX3BhcmVudFZhbHVlKCk7XG5cbiAgICBpZiAocGFyZW50VmFsdWUgPT09IG51bGwgfHwgcGFyZW50VmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuICh0aGlzLmNhY2hlID0gdW5kZWZpbmVkKTtcbiAgICB9XG5cbiAgICBpZiAobGFzdFBhcmVudFZhbHVlID09PSBwYXJlbnRWYWx1ZSkge1xuICAgICAgaW5uZXIgPSB0aGlzLmlubmVyO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgUmVmZXJlbmNlVHlwZSA9IHR5cGVvZiBwYXJlbnRWYWx1ZSA9PT0gJ29iamVjdCcgPyBNZXRhLmZvcihwYXJlbnRWYWx1ZSkucmVmZXJlbmNlVHlwZUZvcihwcm9wZXJ0eSkgOiBQcm9wZXJ0eVJlZmVyZW5jZTtcbiAgICAgIGlubmVyID0gdGhpcy5pbm5lciA9IG5ldyBSZWZlcmVuY2VUeXBlKHBhcmVudFZhbHVlLCBwcm9wZXJ0eSwgdGhpcyk7XG4gICAgfVxuXG4gICAgLy8gaWYgKHR5cGVvZiBwYXJlbnRWYWx1ZSA9PT0gJ29iamVjdCcpIHtcbiAgICAvLyAgIE1ldGEuZm9yKHBhcmVudFZhbHVlKS5hZGRSZWZlcmVuY2UocHJvcGVydHksIHRoaXMpO1xuICAgIC8vIH1cblxuICAgIHJldHVybiAodGhpcy5jYWNoZSA9IGlubmVyLnZhbHVlKCkpO1xuICB9XG5cbiAgbm90aWZ5KCkge1xuICAgIC8vIHRoaXMuX25vdGlmeSgpO1xuICAgIHN1cGVyLm5vdGlmeSgpO1xuICB9XG5cbiAgZ2V0KHByb3A6IEludGVybmVkU3RyaW5nKTogSVBhdGhSZWZlcmVuY2Uge1xuICAgIGxldCBjaGFpbnMgPSB0aGlzLl9nZXRDaGFpbnMoKTtcbiAgICBpZiAoPHN0cmluZz5wcm9wIGluIGNoYWlucykgcmV0dXJuIGNoYWluc1s8c3RyaW5nPnByb3BdO1xuICAgIHJldHVybiAoY2hhaW5zWzxzdHJpbmc+cHJvcF0gPSBuZXcgUGF0aFJlZmVyZW5jZSh0aGlzLCBwcm9wKSk7XG4gIH1cblxuICBjaGFpbihjaGlsZDogUGF0aFJlZmVyZW5jZSk6IERlc3Ryb3lhYmxlIHtcbiAgICBsZXQgbm90aWZ5U2V0ID0gdGhpcy5fZ2V0Tm90aWZ5Q2hpbGRyZW4oKTtcbiAgICBub3RpZnlTZXQuYWRkKGNoaWxkKTtcbiAgICByZXR1cm4gbmV3IFVuY2hhaW5Gcm9tUGF0aChub3RpZnlTZXQsIGNoaWxkKTtcbiAgfVxuXG4gIGZvcmsoKTogUmVmZXJlbmNlIHtcbiAgICByZXR1cm4gbmV3IEZvcmtlZFJlZmVyZW5jZSh0aGlzKTtcbiAgfVxuXG4gIGxhYmVsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuICdbcmVmZXJlbmNlIERpcmVjdF0nO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0Tm90aWZ5Q2hpbGRyZW4oKTogRGljdFNldDxQYXRoUmVmZXJlbmNlPiB7XG4gICAgaWYgKHRoaXMubm90aWZ5Q2hpbGRyZW4pIHJldHVybiB0aGlzLm5vdGlmeUNoaWxkcmVuO1xuICAgIHJldHVybiAodGhpcy5ub3RpZnlDaGlsZHJlbiA9IG5ldyBEaWN0U2V0PFBhdGhSZWZlcmVuY2U+KCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0Q2hhaW5zKCk6IERpY3Q8UGF0aFJlZmVyZW5jZT4ge1xuICAgIGlmICh0aGlzLmNoYWlucykgcmV0dXJuIHRoaXMuY2hhaW5zO1xuICAgIHJldHVybiAodGhpcy5jaGFpbnMgPSBkaWN0PFBhdGhSZWZlcmVuY2U+KCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcGFyZW50VmFsdWUoKSB7XG4gICAgdmFyIHBhcmVudCA9IHRoaXMucGFyZW50LnZhbHVlKCk7XG4gICAgdGhpcy5sYXN0UGFyZW50VmFsdWUgPSBwYXJlbnQ7XG4gICAgcmV0dXJuIHBhcmVudDtcbiAgfVxufVxuIl19