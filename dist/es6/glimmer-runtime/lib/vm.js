import { clear, move } from './bounds';
import { ElementStack } from './builder';
import { Stack, LinkedList, dict } from 'glimmer-util';
import { ConstReference } from 'glimmer-reference';
import { EvaluatedArgs } from './compiled/expressions/args';
export class VM {
    constructor(env, scope, elementStack) {
        this.scopeStack = new Stack();
        this.updatingOpcodeStack = new Stack();
        this.listBlockStack = new Stack();
        this.frame = new FrameStack();
        this.env = env;
        this.elementStack = elementStack;
        this.scopeStack.push(scope);
    }
    static initial(env, { elementStack, self, size }) {
        let scope = env.createRootScope(size).init({ self });
        return new VM(env, scope, elementStack);
    }
    goto(op) {
        this.frame.goto(op);
    }
    enter(ops) {
        this.stack().openBlock();
        let updating = new LinkedList();
        let tryOpcode = new TryOpcode({ ops, vm: this, updating });
        this.didEnter(tryOpcode, updating);
    }
    enterWithKey(key, ops) {
        this.stack().openBlock();
        let updating = new LinkedList();
        let tryOpcode = new TryOpcode({ ops, vm: this, updating });
        this.listBlockStack.current.map[key] = tryOpcode;
        this.didEnter(tryOpcode, updating);
    }
    enterList(manager, ops) {
        let updating = new LinkedList();
        this.stack().openBlockList(updating);
        let opcode = new ListBlockOpcode({ ops, vm: this, updating, manager });
        this.listBlockStack.push(opcode);
        this.didEnter(opcode, updating);
    }
    didEnter(opcode, updating) {
        this.updateWith(opcode);
        this.updatingOpcodeStack.push(updating);
    }
    exit() {
        this.stack().closeBlock();
        this.updatingOpcodeStack.pop();
    }
    exitList() {
        this.exit();
        this.listBlockStack.pop();
    }
    updateWith(opcode) {
        this.updatingOpcodeStack.current.insertBefore(opcode, null);
    }
    stack() {
        return this.elementStack;
    }
    scope() {
        return this.scopeStack.current;
    }
    pushFrame(ops, args, templates, frameDidPop) {
        this.frame.push(ops);
        if (args)
            this.frame.setArgs(args);
        if (templates)
            this.frame.setTemplates(templates);
        if (frameDidPop)
            this.frame.setPopHandler(frameDidPop);
    }
    popFrame() {
        let { frame } = this;
        frame.pop();
        let current = frame.getCurrent();
        if (current === null)
            return;
    }
    pushChildScope() {
        this.scopeStack.push(this.scopeStack.current.child());
    }
    popScope() {
        this.scopeStack.pop();
    }
    /// SCOPE HELPERS
    getSelf() {
        return this.scope().getSelf();
    }
    referenceForSymbol(symbol) {
        return this.scope().getSymbol(symbol);
    }
    /// EXECUTION
    execute(opcodes, initialize) {
        let { elementStack, frame, updatingOpcodeStack, env } = this;
        let self = this.scope().getSelf();
        elementStack.openBlock();
        updatingOpcodeStack.push(new LinkedList());
        frame.push(opcodes);
        if (initialize)
            initialize(this);
        let opcode;
        while (frame.hasOpcodes()) {
            if (opcode = frame.nextStatement())
                opcode.evaluate(this);
        }
        return new RenderResult(updatingOpcodeStack.pop(), elementStack.closeBlock(), env.getDOM(), self);
    }
    evaluateOpcode(opcode) {
        opcode.evaluate(this);
    }
    invoke(template, args, templates) {
        this.elementStack.openBlock();
        let evaledArgs = args.evaluate(this);
        template.compile(this.env);
        this.pushFrame(template.ops, evaledArgs, templates, this);
    }
    frameDidPop() {
        this.elementStack.closeBlock();
    }
    evaluateOperand(expr) {
        this.frame.setOperand(expr.evaluate(this));
    }
    evaluateArgs(args) {
        let evaledArgs = this.frame.setArgs(args.evaluate(this));
        this.frame.setOperand(evaledArgs.positional.at(0));
    }
    bindArgs(positionalParams, namedParams) {
        let args = this.frame.getArgs();
        if (!args)
            return;
        let { positional, named } = args;
        let scope = this.scope();
        if (positionalParams) {
            for (let i = 0; i < positionalParams.length; i++) {
                let symbol = positionalParams[i];
                if (symbol !== 0) {
                    scope.bindSymbol(symbol, positional.at(i));
                }
            }
        }
        if (namedParams) {
            Object.keys(namedParams).forEach(p => {
                scope.bindSymbol(namedParams[p], named.get(p));
            });
        }
    }
    setTemplates(templates) {
        this.frame.setTemplates(templates);
    }
    invokeTemplate(name) {
        let template = this.frame.getTemplates()[name].raw;
        template.compile(this.env);
        this.pushFrame(template.ops);
    }
}
export default VM;
export class UpdatingVM {
    constructor(dom) {
        this.frameStack = new Stack();
        this.dom = dom;
    }
    execute(opcodes, handler) {
        let { frameStack } = this;
        this.try(opcodes, handler);
        while (true) {
            if (frameStack.isEmpty())
                break;
            let opcode = this.frameStack.current.nextStatement();
            if (opcode === null) {
                this.frameStack.pop();
                continue;
            }
            opcode.evaluate(this);
        }
    }
    try(ops, handler) {
        this.frameStack.push(new UpdatingVMFrame(this, ops, handler));
    }
    throw(initialize) {
        this.frameStack.current.handleException(initialize);
    }
    evaluateOpcode(opcode) {
        opcode.evaluate(this);
    }
}
class BlockOpcode {
    constructor({ ops, vm, updating }) {
        this.type = "block";
        this.next = null;
        this.prev = null;
        this.ops = ops;
        this.updating = updating;
        this.env = vm.env;
        this.scope = vm.scope();
        this.bounds = vm.stack().block();
    }
    parentElement() {
        return this.bounds.parentElement();
    }
    firstNode() {
        return this.bounds.firstNode();
    }
    lastNode() {
        return this.bounds.lastNode();
    }
    evaluate(vm) {
        vm.try(this.updating, null);
    }
}
class TryOpcode extends BlockOpcode {
    constructor(...args) {
        super(...args);
        this.type = "try";
    }
    evaluate(vm) {
        vm.try(this.updating, this);
    }
    handleException(initialize) {
        let stack = new ElementStack({
            dom: this.env.getDOM(),
            parentNode: this.bounds.parentElement(),
            nextSibling: initialize ? this.bounds.lastNode().nextSibling : clear(this.bounds)
        });
        let vm = new VM(this.env, this.scope, stack);
        let result = vm.execute(this.ops, initialize);
        if (!initialize) {
            this.updating = result.opcodes();
        }
        this.bounds = result;
    }
}
class ListRevalidationDelegate {
    constructor(opcode) {
        let { map, updating } = opcode;
        this.opcode = opcode;
        this.map = map;
        this.updating = updating;
    }
    insert(key, item, before) {
        let { map, opcode, updating } = this;
        let nextSibling = null;
        let reference = null;
        if (before) {
            reference = map[before];
            nextSibling = reference.bounds.firstNode();
        }
        let vm = opcode.vmForInsertion(nextSibling);
        let tryOpcode;
        vm.execute(opcode.ops, vm => {
            vm.frame.setArgs(EvaluatedArgs.positional([item]));
            vm.frame.setOperand(item);
            vm.frame.setCondition(new ConstReference(true));
            vm.frame.setKey(key);
            tryOpcode = new TryOpcode({
                vm,
                ops: opcode.ops,
                updating: vm.updatingOpcodeStack.current
            });
        });
        updating.insertBefore(tryOpcode, reference);
        map[key] = tryOpcode;
    }
    retain(key, item) {
    }
    move(key, item, before) {
        let { map, updating } = this;
        let entry = map[key];
        let reference = map[before] || null;
        if (before) {
            move(entry, reference.firstNode());
        }
        else {
            move(entry, this.opcode.lastNode());
        }
        updating.remove(entry);
        updating.insertBefore(entry, reference);
    }
    delete(key) {
        let { map } = this;
        let opcode = map[key];
        clear(opcode);
        this.updating.remove(opcode);
        delete map[key];
    }
    done() {
        // this.vm.registers.condition = new ConstReference(false);
    }
}
class ListBlockOpcode extends BlockOpcode {
    constructor(options) {
        super(options);
        this.type = "list-block";
        this.map = dict();
        this.manager = options.manager;
    }
    firstNode() {
        let head = this.updating.head();
        if (head) {
            return head.firstNode();
        }
        else {
            return this.lastNode();
        }
    }
    lastNode() {
        return this.bounds.lastNode();
    }
    evaluate(vm) {
        // Revalidate list somehow....
        let delegate = new ListRevalidationDelegate(this);
        this.manager.sync(delegate);
        // Run now-updated updating opcodes
        super.evaluate(vm);
    }
    vmForInsertion(nextSibling) {
        let stack = new ElementStack({
            dom: this.env.getDOM(),
            parentNode: this.bounds.parentElement(),
            nextSibling: nextSibling || this.bounds.lastNode()
        });
        return new VM(this.env, this.scope, stack);
    }
}
class UpdatingVMFrame {
    constructor(vm, ops, handler) {
        this.vm = vm;
        this.ops = ops;
        this.current = ops.head();
        this.exceptionHandler = handler;
    }
    nextStatement() {
        let { current, ops } = this;
        if (current)
            this.current = ops.nextNode(current);
        return current;
    }
    handleException(initialize) {
        this.exceptionHandler.handleException(initialize);
    }
}
export class RenderResult {
    constructor(updating, bounds, dom, self) {
        this.updating = updating;
        this.bounds = bounds;
        this.dom = dom;
        this.self = self;
    }
    rerender(self) {
        let vm = new UpdatingVM(this.dom);
        if (self !== undefined) {
            this.self.update(self);
        }
        vm.execute(this.updating, this);
    }
    parentElement() {
        return this.bounds.parentElement();
    }
    firstNode() {
        return this.bounds.firstNode();
    }
    lastNode() {
        return this.bounds.lastNode();
    }
    opcodes() {
        return this.updating;
    }
    handleException() {
        throw "this should never happen";
    }
}
class Frame {
    constructor(ops) {
        this.operand = null;
        this.args = null;
        this.condition = null;
        this.iterator = null;
        this.key = null;
        this.templates = null;
        this.popHandler = null;
        this.ops = ops;
        this.op = ops.head();
    }
}
class FrameStack {
    constructor() {
        this.frames = [];
        this.frame = undefined;
    }
    push(ops) {
        let frame = (this.frame === undefined) ? (this.frame = 0) : ++this.frame;
        if (this.frames.length <= frame) {
            this.frames.push(null);
        }
        this.frames[frame] = new Frame(ops);
    }
    pop() {
        let popHandler = this.getPopHandler();
        if (popHandler)
            popHandler.frameDidPop();
        let { frames, frame } = this;
        frames[frame] = null;
        this.frame = frame === 0 ? undefined : frame - 1;
    }
    getOps() {
        return this.frames[this.frame].ops;
    }
    getCurrent() {
        return this.frames[this.frame].op;
    }
    setCurrent(op) {
        return this.frames[this.frame].op = op;
    }
    getOperand() {
        return this.frames[this.frame].operand;
    }
    setOperand(operand) {
        return this.frames[this.frame].operand = operand;
    }
    getArgs() {
        return this.frames[this.frame].args;
    }
    setArgs(args) {
        return this.frames[this.frame].args = args;
    }
    getCondition() {
        return this.frames[this.frame].condition;
    }
    setCondition(condition) {
        return this.frames[this.frame].condition = condition;
    }
    getIterator() {
        return this.frames[this.frame].iterator;
    }
    setIterator(iterator) {
        return this.frames[this.frame].iterator = iterator;
    }
    getKey() {
        return this.frames[this.frame].key;
    }
    setKey(key) {
        return this.frames[this.frame].key = key;
    }
    getTemplates() {
        return this.frames[this.frame].templates;
    }
    setTemplates(templates) {
        return this.frames[this.frame].templates = templates;
    }
    getPopHandler() {
        return this.frames[this.frame].popHandler;
    }
    setPopHandler(handler) {
        return this.frames[this.frame].popHandler = handler;
    }
    goto(op) {
        this.setCurrent(op);
    }
    hasOpcodes() {
        return this.frame !== undefined;
    }
    nextStatement() {
        let op = this.frames[this.frame].op;
        let ops = this.getOps();
        if (op) {
            this.setCurrent(ops.nextNode(op));
            return op;
        }
        else {
            this.pop();
            return null;
        }
    }
}
var Slots;
(function (Slots) {
    Slots[Slots["Ops"] = 0] = "Ops";
    Slots[Slots["Current"] = 1] = "Current";
    Slots[Slots["Operand"] = 2] = "Operand";
    Slots[Slots["Args"] = 3] = "Args";
    Slots[Slots["Condition"] = 4] = "Condition";
    Slots[Slots["Iterator"] = 5] = "Iterator";
    Slots[Slots["Key"] = 6] = "Key";
    Slots[Slots["Templates"] = 7] = "Templates";
})(Slots || (Slots = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnbGltbWVyLXJ1bnRpbWUvbGliL3ZtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJPQUNPLEVBQVUsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLFVBQVU7T0FDdkMsRUFBRSxZQUFZLEVBQUUsTUFBTSxXQUFXO09BQ2pDLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBd0IsSUFBSSxFQUFFLE1BQU0sY0FBYztPQUNyRSxFQUFFLGNBQWMsRUFBNkYsTUFBTSxtQkFBbUI7T0FLdEksRUFBZ0IsYUFBYSxFQUFFLE1BQU0sNkJBQTZCO0FBMEJ6RTtJQWFFLFlBQVksR0FBZ0IsRUFBRSxLQUFZLEVBQUUsWUFBMEI7UUFYOUQsZUFBVSxHQUFHLElBQUksS0FBSyxFQUFTLENBQUM7UUFFakMsd0JBQW1CLEdBQUcsSUFBSSxLQUFLLEVBQThCLENBQUM7UUFDOUQsbUJBQWMsR0FBRyxJQUFJLEtBQUssRUFBbUIsQ0FBQztRQUM5QyxVQUFLLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQztRQVE5QixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFURCxPQUFPLE9BQU8sQ0FBQyxHQUFnQixFQUFFLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQWE7UUFDdEUsSUFBSSxLQUFLLEdBQUcsR0FBRyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3JELE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFRRCxJQUFJLENBQUMsRUFBVTtRQUNiLElBQUksQ0FBQyxLQUFLLENB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QUUsQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxVQUFVO1FBQ1IsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUFDO0lBQ2xDLENBQUM7SUFFRCxhQUFhO1FBQ1gsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ3BDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUV4QixFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ1AsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbEMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUNaLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNYLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztBQUNILENBQUM7QUFFRCxJQUFLLEtBU0o7QUFURCxXQUFLLEtBQUs7SUFDUiwrQkFBTyxDQUFBO0lBQ1AsdUNBQVcsQ0FBQTtJQUNYLHVDQUFXLENBQUE7SUFDWCxpQ0FBUSxDQUFBO0lBQ1IsMkNBQWEsQ0FBQTtJQUNiLHlDQUFZLENBQUE7SUFDWiwrQkFBTyxDQUFBO0lBQ1AsMkNBQWEsQ0FBQTtBQUNmLENBQUMsRUFUSSxLQUFLLEtBQUwsS0FBSyxRQVNUIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2NvcGUsIEVudmlyb25tZW50IH0gZnJvbSAnLi9lbnZpcm9ubWVudCc7XG5pbXBvcnQgeyBCb3VuZHMsIGNsZWFyLCBtb3ZlIH0gZnJvbSAnLi9ib3VuZHMnO1xuaW1wb3J0IHsgRWxlbWVudFN0YWNrIH0gZnJvbSAnLi9idWlsZGVyJztcbmltcG9ydCB7IFN0YWNrLCBMaW5rZWRMaXN0LCBJbnRlcm5lZFN0cmluZywgRGljdCwgZGljdCB9IGZyb20gJ2dsaW1tZXItdXRpbCc7XG5pbXBvcnQgeyBDb25zdFJlZmVyZW5jZSwgQ2hhaW5hYmxlUmVmZXJlbmNlLCBQYXRoUmVmZXJlbmNlLCBSb290UmVmZXJlbmNlLCBMaXN0TWFuYWdlciwgTGlzdEl0ZXJhdG9yLCBMaXN0RGVsZWdhdGUgfSBmcm9tICdnbGltbWVyLXJlZmVyZW5jZSc7XG5pbXBvcnQgVGVtcGxhdGUgZnJvbSAnLi90ZW1wbGF0ZSc7XG5pbXBvcnQgeyBUZW1wbGF0ZXMgfSBmcm9tICcuL3N5bnRheC9jb3JlJztcbmltcG9ydCB7IFJhd1RlbXBsYXRlIH0gZnJvbSAnLi9jb21waWxlcic7XG5pbXBvcnQgeyBDb21waWxlZEV4cHJlc3Npb24gfSBmcm9tICcuL2NvbXBpbGVkL2V4cHJlc3Npb25zJztcbmltcG9ydCB7IENvbXBpbGVkQXJncywgRXZhbHVhdGVkQXJncyB9IGZyb20gJy4vY29tcGlsZWQvZXhwcmVzc2lvbnMvYXJncyc7XG5pbXBvcnQgeyBPcGNvZGUsIE9wU2VxLCBVcGRhdGluZ09wY29kZSwgVXBkYXRpbmdPcFNlcSB9IGZyb20gJy4vb3Bjb2Rlcyc7XG5pbXBvcnQgeyBSYW5nZSB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IERPTUhlbHBlciBmcm9tICcuL2RvbSc7XG5cbmludGVyZmFjZSBWTU9wdGlvbnMge1xuICBzZWxmOiBSb290UmVmZXJlbmNlO1xuICBlbGVtZW50U3RhY2s6IEVsZW1lbnRTdGFjaztcbiAgc2l6ZTogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgUmVnaXN0ZXJzIHtcbiAgb3BlcmFuZDogUGF0aFJlZmVyZW5jZTtcbiAgYXJnczogRXZhbHVhdGVkQXJncztcbiAgY29uZGl0aW9uOiBDaGFpbmFibGVSZWZlcmVuY2U7XG4gIGl0ZXJhdG9yOiBMaXN0SXRlcmF0b3I7XG4gIGtleTogSW50ZXJuZWRTdHJpbmc7XG4gIHRlbXBsYXRlczogRGljdDxUZW1wbGF0ZT47XG59XG5cbmludGVyZmFjZSBGcmFtZURpZFBvcCB7XG4gIGZyYW1lRGlkUG9wKCk7XG59XG5cbnR5cGUgT3BMaXN0ID0gUmFuZ2U8T3Bjb2RlPjtcblxuZXhwb3J0IGNsYXNzIFZNIHtcbiAgcHVibGljIGVudjogRW52aXJvbm1lbnQ7XG4gIHByaXZhdGUgc2NvcGVTdGFjayA9IG5ldyBTdGFjazxTY29wZT4oKTtcbiAgcHJpdmF0ZSBlbGVtZW50U3RhY2s6IEVsZW1lbnRTdGFjaztcbiAgcHVibGljIHVwZGF0aW5nT3Bjb2RlU3RhY2sgPSBuZXcgU3RhY2s8TGlua2VkTGlzdDxVcGRhdGluZ09wY29kZT4+KCk7XG4gIHB1YmxpYyBsaXN0QmxvY2tTdGFjayA9IG5ldyBTdGFjazxMaXN0QmxvY2tPcGNvZGU+KCk7XG4gIHB1YmxpYyBmcmFtZSA9IG5ldyBGcmFtZVN0YWNrKCk7XG5cbiAgc3RhdGljIGluaXRpYWwoZW52OiBFbnZpcm9ubWVudCwgeyBlbGVtZW50U3RhY2ssIHNlbGYsIHNpemUgfTogVk1PcHRpb25zKSB7XG4gICAgbGV0IHNjb3BlID0gZW52LmNyZWF0ZVJvb3RTY29wZShzaXplKS5pbml0KHsgc2VsZiB9KTtcbiAgICByZXR1cm4gbmV3IFZNKGVudiwgc2NvcGUsIGVsZW1lbnRTdGFjayk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihlbnY6IEVudmlyb25tZW50LCBzY29wZTogU2NvcGUsIGVsZW1lbnRTdGFjazogRWxlbWVudFN0YWNrKSB7XG4gICAgdGhpcy5lbnYgPSBlbnY7XG4gICAgdGhpcy5lbGVtZW50U3RhY2sgPSBlbGVtZW50U3RhY2s7XG4gICAgdGhpcy5zY29wZVN0YWNrLnB1c2goc2NvcGUpO1xuICB9XG5cbiAgZ290byhvcDogT3Bjb2RlKSB7XG4gICAgdGhpcy5mcmFtZS5nb3RvKG9wKTtcbiAgfVxuXG4gIGVudGVyKG9wczogT3BTZXEpIHtcbiAgICB0aGlzLnN0YWNrKCkub3BlbkJsb2NrKCk7XG5cbiAgICBsZXQgdXBkYXRpbmcgPSBuZXcgTGlua2VkTGlzdDxVcGRhdGluZ09wY29kZT4oKTtcblxuICAgIGxldCB0cnlPcGNvZGUgPSBuZXcgVHJ5T3Bjb2RlKHsgb3BzLCB2bTogdGhpcywgdXBkYXRpbmcgfSk7XG5cbiAgICB0aGlzLmRpZEVudGVyKHRyeU9wY29kZSwgdXBkYXRpbmcpO1xuICB9XG5cbiAgZW50ZXJXaXRoS2V5KGtleTogSW50ZXJuZWRTdHJpbmcsIG9wczogT3BTZXEpIHtcbiAgICB0aGlzLnN0YWNrKCkub3BlbkJsb2NrKCk7XG5cbiAgICBsZXQgdXBkYXRpbmcgPSBuZXcgTGlua2VkTGlzdDxVcGRhdGluZ09wY29kZT4oKTtcblxuICAgIGxldCB0cnlPcGNvZGUgPSBuZXcgVHJ5T3Bjb2RlKHsgb3BzLCB2bTogdGhpcywgdXBkYXRpbmcgfSk7XG5cbiAgICB0aGlzLmxpc3RCbG9ja1N0YWNrLmN1cnJlbnQubWFwWzxzdHJpbmc+a2V5XSA9IHRyeU9wY29kZTtcblxuICAgIHRoaXMuZGlkRW50ZXIodHJ5T3Bjb2RlLCB1cGRhdGluZyk7XG4gIH1cblxuICBlbnRlckxpc3QobWFuYWdlcjogTGlzdE1hbmFnZXIsIG9wczogT3BTZXEpIHtcbiAgICBsZXQgdXBkYXRpbmcgPSBuZXcgTGlua2VkTGlzdDxCbG9ja09wY29kZT4oKTtcbiAgICB0aGlzLnN0YWNrKCkub3BlbkJsb2NrTGlzdCh1cGRhdGluZyk7XG5cbiAgICBsZXQgb3Bjb2RlID0gbmV3IExpc3RCbG9ja09wY29kZSh7IG9wcywgdm06IHRoaXMsIHVwZGF0aW5nLCBtYW5hZ2VyIH0pO1xuXG4gICAgdGhpcy5saXN0QmxvY2tTdGFjay5wdXNoKG9wY29kZSk7XG5cbiAgICB0aGlzLmRpZEVudGVyKG9wY29kZSwgdXBkYXRpbmcpO1xuICB9XG5cbiAgcHJpdmF0ZSBkaWRFbnRlcihvcGNvZGU6IEJsb2NrT3Bjb2RlLCB1cGRhdGluZzogTGlua2VkTGlzdDxVcGRhdGluZ09wY29kZT4pIHtcbiAgICB0aGlzLnVwZGF0ZVdpdGgob3Bjb2RlKTtcbiAgICB0aGlzLnVwZGF0aW5nT3Bjb2RlU3RhY2sucHVzaCh1cGRhdGluZyk7XG4gIH1cblxuICBleGl0KCkge1xuICAgIHRoaXMuc3RhY2soKS5jbG9zZUJsb2NrKCk7XG4gICAgdGhpcy51cGRhdGluZ09wY29kZVN0YWNrLnBvcCgpO1xuICB9XG5cbiAgZXhpdExpc3QoKSB7XG4gICAgdGhpcy5leGl0KCk7XG4gICAgdGhpcy5saXN0QmxvY2tTdGFjay5wb3AoKTtcbiAgfVxuXG4gIHVwZGF0ZVdpdGgob3Bjb2RlOiBVcGRhdGluZ09wY29kZSkge1xuICAgIHRoaXMudXBkYXRpbmdPcGNvZGVTdGFjay5jdXJyZW50Lmluc2VydEJlZm9yZShvcGNvZGUsIG51bGwpO1xuICB9XG5cbiAgc3RhY2soKTogRWxlbWVudFN0YWNrIHtcbiAgICByZXR1cm4gdGhpcy5lbGVtZW50U3RhY2s7XG4gIH1cblxuICBzY29wZSgpOiBTY29wZSB7XG4gICAgcmV0dXJuIHRoaXMuc2NvcGVTdGFjay5jdXJyZW50O1xuICB9XG5cbiAgcHVzaEZyYW1lKG9wczogT3BTZXEsIGFyZ3M/OiBFdmFsdWF0ZWRBcmdzLCB0ZW1wbGF0ZXM/OiBUZW1wbGF0ZXMsIGZyYW1lRGlkUG9wPzogRnJhbWVEaWRQb3ApIHtcbiAgICB0aGlzLmZyYW1lLnB1c2gob3BzKTtcbiAgICBpZiAoYXJncykgdGhpcy5mcmFtZS5zZXRBcmdzKGFyZ3MpO1xuICAgIGlmICh0ZW1wbGF0ZXMpIHRoaXMuZnJhbWUuc2V0VGVtcGxhdGVzKDxhbnk+dGVtcGxhdGVzKTtcbiAgICBpZiAoZnJhbWVEaWRQb3ApIHRoaXMuZnJhbWUuc2V0UG9wSGFuZGxlcihmcmFtZURpZFBvcCk7XG4gIH1cblxuICBwb3BGcmFtZSgpIHtcbiAgICBsZXQgeyBmcmFtZSB9ID0gdGhpcztcblxuICAgIGZyYW1lLnBvcCgpO1xuICAgIGxldCBjdXJyZW50ID0gZnJhbWUuZ2V0Q3VycmVudCgpO1xuXG4gICAgaWYgKGN1cnJlbnQgPT09IG51bGwpIHJldHVybjtcbiAgfVxuXG4gIHB1c2hDaGlsZFNjb3BlKCkge1xuICAgIHRoaXMuc2NvcGVTdGFjay5wdXNoKHRoaXMuc2NvcGVTdGFjay5jdXJyZW50LmNoaWxkKCkpO1xuICB9XG5cbiAgcG9wU2NvcGUoKSB7XG4gICAgdGhpcy5zY29wZVN0YWNrLnBvcCgpO1xuICB9XG5cbiAgLy8vIFNDT1BFIEhFTFBFUlNcblxuICBnZXRTZWxmKCkge1xuICAgIHJldHVybiB0aGlzLnNjb3BlKCkuZ2V0U2VsZigpO1xuICB9XG5cbiAgcmVmZXJlbmNlRm9yU3ltYm9sKHN5bWJvbDogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuc2NvcGUoKS5nZXRTeW1ib2woc3ltYm9sKTtcbiAgfVxuXG4gIC8vLyBFWEVDVVRJT05cblxuICBleGVjdXRlKG9wY29kZXM6IE9wU2VxLCBpbml0aWFsaXplPzogKHZtOiBWTSkgPT4gdm9pZCk6IFJlbmRlclJlc3VsdCB7XG4gICAgbGV0IHsgZWxlbWVudFN0YWNrLCBmcmFtZSwgdXBkYXRpbmdPcGNvZGVTdGFjaywgZW52IH0gPSB0aGlzO1xuICAgIGxldCBzZWxmID0gdGhpcy5zY29wZSgpLmdldFNlbGYoKTtcblxuICAgIGVsZW1lbnRTdGFjay5vcGVuQmxvY2soKTtcblxuICAgIHVwZGF0aW5nT3Bjb2RlU3RhY2sucHVzaChuZXcgTGlua2VkTGlzdDxVcGRhdGluZ09wY29kZT4oKSk7XG4gICAgZnJhbWUucHVzaChvcGNvZGVzKTtcblxuICAgIGlmIChpbml0aWFsaXplKSBpbml0aWFsaXplKHRoaXMpO1xuXG4gICAgbGV0IG9wY29kZTogT3Bjb2RlO1xuXG4gICAgd2hpbGUgKGZyYW1lLmhhc09wY29kZXMoKSkge1xuICAgICAgaWYgKG9wY29kZSA9IGZyYW1lLm5leHRTdGF0ZW1lbnQoKSkgb3Bjb2RlLmV2YWx1YXRlKHRoaXMpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgUmVuZGVyUmVzdWx0KHVwZGF0aW5nT3Bjb2RlU3RhY2sucG9wKCksIGVsZW1lbnRTdGFjay5jbG9zZUJsb2NrKCksIGVudi5nZXRET00oKSwgc2VsZik7XG4gIH1cblxuICBldmFsdWF0ZU9wY29kZShvcGNvZGU6IE9wY29kZSkge1xuICAgIG9wY29kZS5ldmFsdWF0ZSh0aGlzKTtcbiAgfVxuXG4gIGludm9rZSh0ZW1wbGF0ZTogUmF3VGVtcGxhdGUsIGFyZ3M6IENvbXBpbGVkQXJncywgdGVtcGxhdGVzOiBUZW1wbGF0ZXMpIHtcbiAgICB0aGlzLmVsZW1lbnRTdGFjay5vcGVuQmxvY2soKTtcbiAgICBsZXQgZXZhbGVkQXJncyA9IGFyZ3MuZXZhbHVhdGUodGhpcyk7XG4gICAgdGVtcGxhdGUuY29tcGlsZSh0aGlzLmVudik7XG4gICAgdGhpcy5wdXNoRnJhbWUodGVtcGxhdGUub3BzLCBldmFsZWRBcmdzLCB0ZW1wbGF0ZXMsIHRoaXMpO1xuICB9XG5cbiAgZnJhbWVEaWRQb3AoKSB7XG4gICAgdGhpcy5lbGVtZW50U3RhY2suY2xvc2VCbG9jaygpO1xuICB9XG5cbiAgZXZhbHVhdGVPcGVyYW5kKGV4cHI6IENvbXBpbGVkRXhwcmVzc2lvbikge1xuICAgIHRoaXMuZnJhbWUuc2V0T3BlcmFuZChleHByLmV2YWx1YXRlKHRoaXMpKTtcbiAgfVxuXG4gIGV2YWx1YXRlQXJncyhhcmdzOiBDb21waWxlZEFyZ3MpIHtcbiAgICBsZXQgZXZhbGVkQXJncyA9IHRoaXMuZnJhbWUuc2V0QXJncyhhcmdzLmV2YWx1YXRlKHRoaXMpKTtcbiAgICB0aGlzLmZyYW1lLnNldE9wZXJhbmQoZXZhbGVkQXJncy5wb3NpdGlvbmFsLmF0KDApKTtcbiAgfVxuXG4gIGJpbmRBcmdzKHBvc2l0aW9uYWxQYXJhbXM6IG51bWJlcltdLCBuYW1lZFBhcmFtczogRGljdDxudW1iZXI+KSB7XG4gICAgbGV0IGFyZ3MgPSB0aGlzLmZyYW1lLmdldEFyZ3MoKTtcbiAgICBpZiAoIWFyZ3MpIHJldHVybjtcblxuICAgIGxldCB7IHBvc2l0aW9uYWwsIG5hbWVkIH0gPSBhcmdzO1xuXG4gICAgbGV0IHNjb3BlID0gdGhpcy5zY29wZSgpO1xuXG4gICAgaWYgKHBvc2l0aW9uYWxQYXJhbXMpIHtcbiAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbmFsUGFyYW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGxldCBzeW1ib2wgPSBwb3NpdGlvbmFsUGFyYW1zW2ldO1xuXG4gICAgICAgIGlmIChzeW1ib2wgIT09IDApIHtcbiAgICAgICAgICBzY29wZS5iaW5kU3ltYm9sKHN5bWJvbCwgcG9zaXRpb25hbC5hdChpKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobmFtZWRQYXJhbXMpIHtcbiAgICAgIE9iamVjdC5rZXlzKG5hbWVkUGFyYW1zKS5mb3JFYWNoKHAgPT4ge1xuICAgICAgICBzY29wZS5iaW5kU3ltYm9sKG5hbWVkUGFyYW1zW3BdLCBuYW1lZC5nZXQoPEludGVybmVkU3RyaW5nPnApKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHNldFRlbXBsYXRlcyh0ZW1wbGF0ZXM6IERpY3Q8VGVtcGxhdGU+KSB7XG4gICAgdGhpcy5mcmFtZS5zZXRUZW1wbGF0ZXModGVtcGxhdGVzKTtcbiAgfVxuXG4gIGludm9rZVRlbXBsYXRlKG5hbWU6IEludGVybmVkU3RyaW5nKSB7XG4gICAgbGV0IHRlbXBsYXRlID0gdGhpcy5mcmFtZS5nZXRUZW1wbGF0ZXMoKVs8c3RyaW5nPm5hbWVdLnJhdztcbiAgICB0ZW1wbGF0ZS5jb21waWxlKHRoaXMuZW52KTtcbiAgICB0aGlzLnB1c2hGcmFtZSh0ZW1wbGF0ZS5vcHMpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFZNO1xuXG5leHBvcnQgY2xhc3MgVXBkYXRpbmdWTSB7XG4gIHByaXZhdGUgZnJhbWVTdGFjazogU3RhY2s8VXBkYXRpbmdWTUZyYW1lPiA9IG5ldyBTdGFjazxVcGRhdGluZ1ZNRnJhbWU+KCk7XG4gIHB1YmxpYyBkb206IERPTUhlbHBlcjtcblxuICBjb25zdHJ1Y3Rvcihkb206IERPTUhlbHBlcikge1xuICAgIHRoaXMuZG9tID0gZG9tO1xuICB9XG5cbiAgZXhlY3V0ZShvcGNvZGVzOiBVcGRhdGluZ09wU2VxLCBoYW5kbGVyOiBFeGNlcHRpb25IYW5kbGVyKSB7XG4gICAgbGV0IHsgZnJhbWVTdGFjayB9ID0gdGhpcztcblxuICAgIHRoaXMudHJ5KG9wY29kZXMsIGhhbmRsZXIpO1xuXG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIGlmIChmcmFtZVN0YWNrLmlzRW1wdHkoKSkgYnJlYWs7XG5cbiAgICAgIGxldCBvcGNvZGUgPSB0aGlzLmZyYW1lU3RhY2suY3VycmVudC5uZXh0U3RhdGVtZW50KCk7XG5cbiAgICAgIGlmIChvcGNvZGUgPT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5mcmFtZVN0YWNrLnBvcCgpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgb3Bjb2RlLmV2YWx1YXRlKHRoaXMpO1xuICAgIH1cbiAgfVxuXG4gIHRyeShvcHM6IFVwZGF0aW5nT3BTZXEsIGhhbmRsZXI6IEV4Y2VwdGlvbkhhbmRsZXIpIHtcbiAgICB0aGlzLmZyYW1lU3RhY2sucHVzaChuZXcgVXBkYXRpbmdWTUZyYW1lKHRoaXMsIG9wcywgaGFuZGxlcikpO1xuICB9XG5cbiAgdGhyb3coaW5pdGlhbGl6ZT86ICh2bTogVk0pID0+IHZvaWQpIHtcbiAgICB0aGlzLmZyYW1lU3RhY2suY3VycmVudC5oYW5kbGVFeGNlcHRpb24oaW5pdGlhbGl6ZSk7XG4gIH1cblxuICBldmFsdWF0ZU9wY29kZShvcGNvZGU6IFVwZGF0aW5nT3Bjb2RlKSB7XG4gICAgb3Bjb2RlLmV2YWx1YXRlKHRoaXMpO1xuICB9XG59XG5cbmludGVyZmFjZSBFeGNlcHRpb25IYW5kbGVyIHtcbiAgaGFuZGxlRXhjZXB0aW9uKGluaXRpYWxpemU/OiAodm06IFZNKSA9PiB2b2lkKTtcbn1cblxuaW50ZXJmYWNlIEJsb2NrT3Bjb2RlT3B0aW9ucyB7XG4gIG9wczogT3BTZXE7XG4gIHZtOiBWTTtcbiAgdXBkYXRpbmc6IExpbmtlZExpc3Q8VXBkYXRpbmdPcGNvZGU+O1xufVxuXG5hYnN0cmFjdCBjbGFzcyBCbG9ja09wY29kZSBpbXBsZW1lbnRzIFVwZGF0aW5nT3Bjb2RlLCBCb3VuZHMge1xuICBwdWJsaWMgdHlwZSA9IFwiYmxvY2tcIjtcbiAgcHVibGljIG5leHQgPSBudWxsO1xuICBwdWJsaWMgcHJldiA9IG51bGw7XG5cbiAgcHJvdGVjdGVkIGVudjogRW52aXJvbm1lbnQ7XG4gIHByb3RlY3RlZCBzY29wZTogU2NvcGU7XG4gIHByb3RlY3RlZCB1cGRhdGluZzogTGlua2VkTGlzdDxVcGRhdGluZ09wY29kZT47XG4gIHByb3RlY3RlZCBib3VuZHM6IEJvdW5kcztcbiAgcHVibGljIG9wczogT3BTZXE7XG5cbiAgY29uc3RydWN0b3IoeyBvcHMsIHZtLCB1cGRhdGluZyB9OiBCbG9ja09wY29kZU9wdGlvbnMpIHtcbiAgICB0aGlzLm9wcyA9IG9wcztcbiAgICB0aGlzLnVwZGF0aW5nID0gdXBkYXRpbmc7XG4gICAgdGhpcy5lbnYgPSB2bS5lbnY7XG4gICAgdGhpcy5zY29wZSA9IHZtLnNjb3BlKCk7XG4gICAgdGhpcy5ib3VuZHMgPSB2bS5zdGFjaygpLmJsb2NrKCk7XG4gIH1cblxuICBwYXJlbnRFbGVtZW50KCkge1xuICAgIHJldHVybiB0aGlzLmJvdW5kcy5wYXJlbnRFbGVtZW50KCk7XG4gIH1cblxuICBmaXJzdE5vZGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuYm91bmRzLmZpcnN0Tm9kZSgpO1xuICB9XG5cbiAgbGFzdE5vZGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuYm91bmRzLmxhc3ROb2RlKCk7XG4gIH1cblxuICBldmFsdWF0ZSh2bTogVXBkYXRpbmdWTSkge1xuICAgIHZtLnRyeSh0aGlzLnVwZGF0aW5nLCBudWxsKTtcbiAgfVxufVxuXG5jbGFzcyBUcnlPcGNvZGUgZXh0ZW5kcyBCbG9ja09wY29kZSBpbXBsZW1lbnRzIFVwZGF0aW5nT3Bjb2RlLCBFeGNlcHRpb25IYW5kbGVyIHtcbiAgcHVibGljIHR5cGUgPSBcInRyeVwiO1xuXG4gIGV2YWx1YXRlKHZtOiBVcGRhdGluZ1ZNKSB7XG4gICAgdm0udHJ5KHRoaXMudXBkYXRpbmcsIHRoaXMpO1xuICB9XG5cbiAgaGFuZGxlRXhjZXB0aW9uKGluaXRpYWxpemU/OiAodm06IFZNKSA9PiB2b2lkKSB7XG4gICAgbGV0IHN0YWNrID0gbmV3IEVsZW1lbnRTdGFjayh7XG4gICAgICBkb206IHRoaXMuZW52LmdldERPTSgpLFxuICAgICAgcGFyZW50Tm9kZTogdGhpcy5ib3VuZHMucGFyZW50RWxlbWVudCgpLFxuICAgICAgbmV4dFNpYmxpbmc6IGluaXRpYWxpemUgPyB0aGlzLmJvdW5kcy5sYXN0Tm9kZSgpLm5leHRTaWJsaW5nIDogY2xlYXIodGhpcy5ib3VuZHMpXG4gICAgfSk7XG5cbiAgICBsZXQgdm0gPSBuZXcgVk0odGhpcy5lbnYsIHRoaXMuc2NvcGUsIHN0YWNrKTtcbiAgICBsZXQgcmVzdWx0ID0gdm0uZXhlY3V0ZSh0aGlzLm9wcywgaW5pdGlhbGl6ZSk7XG5cbiAgICBpZiAoIWluaXRpYWxpemUpIHtcbiAgICAgIHRoaXMudXBkYXRpbmcgPSByZXN1bHQub3Bjb2RlcygpO1xuICAgIH1cblxuICAgIHRoaXMuYm91bmRzID0gcmVzdWx0O1xuICB9XG59XG5cbmNsYXNzIExpc3RSZXZhbGlkYXRpb25EZWxlZ2F0ZSBpbXBsZW1lbnRzIExpc3REZWxlZ2F0ZSB7XG4gIHByaXZhdGUgb3Bjb2RlOiBMaXN0QmxvY2tPcGNvZGU7XG4gIHByaXZhdGUgbWFwOiBEaWN0PEJsb2NrT3Bjb2RlPjtcbiAgcHJpdmF0ZSB1cGRhdGluZzogTGlua2VkTGlzdDxVcGRhdGluZ09wY29kZT47XG5cbiAgY29uc3RydWN0b3Iob3Bjb2RlOiBMaXN0QmxvY2tPcGNvZGUpIHtcbiAgICBsZXQgeyBtYXAsIHVwZGF0aW5nIH0gPSBvcGNvZGU7XG4gICAgdGhpcy5vcGNvZGUgPSBvcGNvZGU7XG4gICAgdGhpcy5tYXAgPSBtYXA7XG4gICAgdGhpcy51cGRhdGluZyA9IHVwZGF0aW5nO1xuICB9XG5cbiAgaW5zZXJ0KGtleTogSW50ZXJuZWRTdHJpbmcsIGl0ZW06IFJvb3RSZWZlcmVuY2UsIGJlZm9yZTogSW50ZXJuZWRTdHJpbmcpIHtcbiAgICBsZXQgeyBtYXAsIG9wY29kZSwgdXBkYXRpbmcgfSA9IHRoaXM7XG4gICAgbGV0IG5leHRTaWJsaW5nOiBOb2RlID0gbnVsbDtcbiAgICBsZXQgcmVmZXJlbmNlID0gbnVsbDtcblxuICAgIGlmIChiZWZvcmUpIHtcbiAgICAgIHJlZmVyZW5jZSA9IG1hcFs8c3RyaW5nPmJlZm9yZV07XG4gICAgICBuZXh0U2libGluZyA9IHJlZmVyZW5jZS5ib3VuZHMuZmlyc3ROb2RlKCk7XG4gICAgfVxuXG4gICAgbGV0IHZtID0gb3Bjb2RlLnZtRm9ySW5zZXJ0aW9uKG5leHRTaWJsaW5nKTtcbiAgICBsZXQgdHJ5T3Bjb2RlO1xuXG4gICAgdm0uZXhlY3V0ZShvcGNvZGUub3BzLCB2bSA9PiB7XG4gICAgICB2bS5mcmFtZS5zZXRBcmdzKEV2YWx1YXRlZEFyZ3MucG9zaXRpb25hbChbaXRlbV0pKTtcbiAgICAgIHZtLmZyYW1lLnNldE9wZXJhbmQoaXRlbSk7XG4gICAgICB2bS5mcmFtZS5zZXRDb25kaXRpb24obmV3IENvbnN0UmVmZXJlbmNlKHRydWUpKTtcbiAgICAgIHZtLmZyYW1lLnNldEtleShrZXkpO1xuXG4gICAgICB0cnlPcGNvZGUgPSBuZXcgVHJ5T3Bjb2RlKHtcbiAgICAgICAgdm0sXG4gICAgICAgIG9wczogb3Bjb2RlLm9wcyxcbiAgICAgICAgdXBkYXRpbmc6IHZtLnVwZGF0aW5nT3Bjb2RlU3RhY2suY3VycmVudFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB1cGRhdGluZy5pbnNlcnRCZWZvcmUodHJ5T3Bjb2RlLCByZWZlcmVuY2UpO1xuXG4gICAgbWFwWzxzdHJpbmc+a2V5XSA9IHRyeU9wY29kZTtcbiAgfVxuXG4gIHJldGFpbihrZXk6IEludGVybmVkU3RyaW5nLCBpdGVtOiBSb290UmVmZXJlbmNlKSB7XG4gIH1cblxuICBtb3ZlKGtleTogSW50ZXJuZWRTdHJpbmcsIGl0ZW06IFJvb3RSZWZlcmVuY2UsIGJlZm9yZTogSW50ZXJuZWRTdHJpbmcpIHtcbiAgICBsZXQgeyBtYXAsIHVwZGF0aW5nIH0gPSB0aGlzO1xuXG4gICAgbGV0IGVudHJ5ID0gbWFwWzxzdHJpbmc+a2V5XTtcbiAgICBsZXQgcmVmZXJlbmNlID0gbWFwWzxzdHJpbmc+YmVmb3JlXSB8fCBudWxsO1xuXG4gICAgaWYgKGJlZm9yZSkge1xuICAgICAgbW92ZShlbnRyeSwgcmVmZXJlbmNlLmZpcnN0Tm9kZSgpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbW92ZShlbnRyeSwgdGhpcy5vcGNvZGUubGFzdE5vZGUoKSk7XG4gICAgfVxuXG4gICAgdXBkYXRpbmcucmVtb3ZlKGVudHJ5KTtcbiAgICB1cGRhdGluZy5pbnNlcnRCZWZvcmUoZW50cnksIHJlZmVyZW5jZSk7XG4gIH1cblxuICBkZWxldGUoa2V5OiBJbnRlcm5lZFN0cmluZykge1xuICAgIGxldCB7IG1hcCB9ID0gdGhpcztcbiAgICBsZXQgb3Bjb2RlID0gbWFwWzxzdHJpbmc+a2V5XTtcbiAgICBjbGVhcihvcGNvZGUpO1xuICAgIHRoaXMudXBkYXRpbmcucmVtb3ZlKG9wY29kZSk7XG4gICAgZGVsZXRlIG1hcFs8c3RyaW5nPmtleV07XG4gIH1cblxuICBkb25lKCkge1xuICAgIC8vIHRoaXMudm0ucmVnaXN0ZXJzLmNvbmRpdGlvbiA9IG5ldyBDb25zdFJlZmVyZW5jZShmYWxzZSk7XG4gIH1cbn1cblxuaW50ZXJmYWNlIExpc3RCbG9ja09wY29kZU9wdGlvbnMgZXh0ZW5kcyBCbG9ja09wY29kZU9wdGlvbnMge1xuICBtYW5hZ2VyOiBMaXN0TWFuYWdlcjtcbn1cblxuY2xhc3MgTGlzdEJsb2NrT3Bjb2RlIGV4dGVuZHMgQmxvY2tPcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9IFwibGlzdC1ibG9ja1wiO1xuICBwdWJsaWMgbWFwID0gZGljdDxCbG9ja09wY29kZT4oKTtcbiAgcHVibGljIG1hbmFnZXI6IExpc3RNYW5hZ2VyO1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IExpc3RCbG9ja09wY29kZU9wdGlvbnMpIHtcbiAgICBzdXBlcihvcHRpb25zKTtcbiAgICB0aGlzLm1hbmFnZXIgPSBvcHRpb25zLm1hbmFnZXI7XG4gIH1cblxuICBmaXJzdE5vZGUoKTogTm9kZSB7XG4gICAgbGV0IGhlYWQ6IEJsb2NrT3Bjb2RlID0gPGFueT50aGlzLnVwZGF0aW5nLmhlYWQoKTtcblxuICAgIGlmIChoZWFkKSB7XG4gICAgICByZXR1cm4gaGVhZC5maXJzdE5vZGUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMubGFzdE5vZGUoKTtcbiAgICB9XG4gIH1cblxuICBsYXN0Tm9kZSgpOiBOb2RlIHtcbiAgICByZXR1cm4gdGhpcy5ib3VuZHMubGFzdE5vZGUoKTtcbiAgfVxuXG4gIGV2YWx1YXRlKHZtOiBVcGRhdGluZ1ZNKSB7XG4gICAgLy8gUmV2YWxpZGF0ZSBsaXN0IHNvbWVob3cuLi4uXG4gICAgbGV0IGRlbGVnYXRlID0gbmV3IExpc3RSZXZhbGlkYXRpb25EZWxlZ2F0ZSh0aGlzKTtcblxuICAgIHRoaXMubWFuYWdlci5zeW5jKGRlbGVnYXRlKTtcblxuICAgIC8vIFJ1biBub3ctdXBkYXRlZCB1cGRhdGluZyBvcGNvZGVzXG4gICAgc3VwZXIuZXZhbHVhdGUodm0pO1xuICB9XG5cbiAgdm1Gb3JJbnNlcnRpb24obmV4dFNpYmxpbmc/OiBOb2RlKSB7XG4gICAgbGV0IHN0YWNrID0gbmV3IEVsZW1lbnRTdGFjayh7XG4gICAgICBkb206IHRoaXMuZW52LmdldERPTSgpLFxuICAgICAgcGFyZW50Tm9kZTogdGhpcy5ib3VuZHMucGFyZW50RWxlbWVudCgpLFxuICAgICAgbmV4dFNpYmxpbmc6IG5leHRTaWJsaW5nIHx8IHRoaXMuYm91bmRzLmxhc3ROb2RlKClcbiAgICB9KTtcblxuICAgIHJldHVybiBuZXcgVk0odGhpcy5lbnYsIHRoaXMuc2NvcGUsIHN0YWNrKTtcbiAgfVxufVxuXG5jbGFzcyBVcGRhdGluZ1ZNRnJhbWUge1xuICBwcml2YXRlIHZtOiBVcGRhdGluZ1ZNO1xuICBwcml2YXRlIG9wczogVXBkYXRpbmdPcFNlcTtcbiAgcHJpdmF0ZSBjdXJyZW50OiBVcGRhdGluZ09wY29kZTtcbiAgcHJpdmF0ZSBleGNlcHRpb25IYW5kbGVyOiBFeGNlcHRpb25IYW5kbGVyO1xuXG4gIGNvbnN0cnVjdG9yKHZtOiBVcGRhdGluZ1ZNLCBvcHM6IFVwZGF0aW5nT3BTZXEsIGhhbmRsZXI6IEV4Y2VwdGlvbkhhbmRsZXIpIHtcbiAgICB0aGlzLnZtID0gdm07XG4gICAgdGhpcy5vcHMgPSBvcHM7XG4gICAgdGhpcy5jdXJyZW50ID0gb3BzLmhlYWQoKTtcbiAgICB0aGlzLmV4Y2VwdGlvbkhhbmRsZXIgPSBoYW5kbGVyO1xuICB9XG5cbiAgbmV4dFN0YXRlbWVudCgpOiBVcGRhdGluZ09wY29kZSB7XG4gICAgbGV0IHsgY3VycmVudCwgb3BzIH0gPSB0aGlzO1xuICAgIGlmIChjdXJyZW50KSB0aGlzLmN1cnJlbnQgPSBvcHMubmV4dE5vZGUoY3VycmVudCk7XG4gICAgcmV0dXJuIGN1cnJlbnQ7XG4gIH1cblxuICBoYW5kbGVFeGNlcHRpb24oaW5pdGlhbGl6ZT86ICh2bTogVk0pID0+IHZvaWQpIHtcbiAgICB0aGlzLmV4Y2VwdGlvbkhhbmRsZXIuaGFuZGxlRXhjZXB0aW9uKGluaXRpYWxpemUpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZW5kZXJSZXN1bHQgaW1wbGVtZW50cyBCb3VuZHMsIEV4Y2VwdGlvbkhhbmRsZXIge1xuICBwcml2YXRlIHVwZGF0aW5nOiBMaW5rZWRMaXN0PFVwZGF0aW5nT3Bjb2RlPjtcbiAgcHJpdmF0ZSBib3VuZHM6IEJvdW5kcztcbiAgcHJpdmF0ZSBkb206IERPTUhlbHBlcjtcbiAgcHJpdmF0ZSBzZWxmOiBQYXRoUmVmZXJlbmNlO1xuXG4gIGNvbnN0cnVjdG9yKHVwZGF0aW5nOiBMaW5rZWRMaXN0PFVwZGF0aW5nT3Bjb2RlPiwgYm91bmRzOiBCb3VuZHMsIGRvbTogRE9NSGVscGVyLCBzZWxmOiBQYXRoUmVmZXJlbmNlKSB7XG4gICAgdGhpcy51cGRhdGluZyA9IHVwZGF0aW5nO1xuICAgIHRoaXMuYm91bmRzID0gYm91bmRzO1xuICAgIHRoaXMuZG9tID0gZG9tO1xuICAgIHRoaXMuc2VsZiA9IHNlbGY7XG4gIH1cblxuICByZXJlbmRlcihzZWxmPzogYW55KSB7XG4gICAgbGV0IHZtID0gbmV3IFVwZGF0aW5nVk0odGhpcy5kb20pO1xuXG4gICAgaWYgKHNlbGYgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5zZWxmLnVwZGF0ZShzZWxmKTtcbiAgICB9XG5cbiAgICB2bS5leGVjdXRlKHRoaXMudXBkYXRpbmcsIHRoaXMpO1xuICB9XG5cbiAgcGFyZW50RWxlbWVudCgpIHtcbiAgICByZXR1cm4gdGhpcy5ib3VuZHMucGFyZW50RWxlbWVudCgpO1xuICB9XG5cbiAgZmlyc3ROb2RlKCkge1xuICAgIHJldHVybiB0aGlzLmJvdW5kcy5maXJzdE5vZGUoKTtcbiAgfVxuXG4gIGxhc3ROb2RlKCkge1xuICAgIHJldHVybiB0aGlzLmJvdW5kcy5sYXN0Tm9kZSgpO1xuICB9XG5cbiAgb3Bjb2RlcygpOiBMaW5rZWRMaXN0PFVwZGF0aW5nT3Bjb2RlPiB7XG4gICAgcmV0dXJuIHRoaXMudXBkYXRpbmc7XG4gIH1cblxuICBoYW5kbGVFeGNlcHRpb24oKSB7XG4gICAgdGhyb3cgXCJ0aGlzIHNob3VsZCBuZXZlciBoYXBwZW5cIjtcbiAgfVxufVxuXG5pbnRlcmZhY2UgUmV0dXJuSGFuZGxlciB7XG4gIHNldFJlbmRlclJlc3VsdChyZW5kZXJSZXN1bHQ6IFJlbmRlclJlc3VsdCk7XG59XG5cbmNsYXNzIEZyYW1lIHtcbiAgb3BzOiBPcFNlcTtcbiAgb3A6IE9wY29kZTtcbiAgb3BlcmFuZDogUGF0aFJlZmVyZW5jZSA9IG51bGw7XG4gIGFyZ3M6IEV2YWx1YXRlZEFyZ3MgPSBudWxsO1xuICBjb25kaXRpb246IENoYWluYWJsZVJlZmVyZW5jZSA9IG51bGw7XG4gIGl0ZXJhdG9yOiBMaXN0SXRlcmF0b3IgPSBudWxsO1xuICBrZXk6IEludGVybmVkU3RyaW5nID0gbnVsbDtcbiAgdGVtcGxhdGVzOiBEaWN0PFRlbXBsYXRlPiA9IG51bGw7XG4gIHBvcEhhbmRsZXI6IEZyYW1lRGlkUG9wID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihvcHM6IE9wU2VxKSB7XG4gICAgdGhpcy5vcHMgPSBvcHM7XG4gICAgdGhpcy5vcCA9IG9wcy5oZWFkKCk7XG4gIH1cbn1cblxuY2xhc3MgRnJhbWVTdGFjayB7XG4gIHByaXZhdGUgZnJhbWVzOiBGcmFtZVtdID0gW107XG4gIHByaXZhdGUgZnJhbWU6IG51bWJlciA9IHVuZGVmaW5lZDtcblxuICBwdXNoKG9wczogT3BTZXEpIHtcbiAgICBsZXQgZnJhbWUgPSAodGhpcy5mcmFtZSA9PT0gdW5kZWZpbmVkKSA/ICh0aGlzLmZyYW1lID0gMCkgOiArK3RoaXMuZnJhbWU7XG5cbiAgICBpZiAodGhpcy5mcmFtZXMubGVuZ3RoIDw9IGZyYW1lKSB7XG4gICAgICB0aGlzLmZyYW1lcy5wdXNoKG51bGwpO1xuICAgIH1cblxuICAgIHRoaXMuZnJhbWVzW2ZyYW1lXSA9IG5ldyBGcmFtZShvcHMpO1xuICB9XG5cbiAgcG9wKCkge1xuICAgIGxldCBwb3BIYW5kbGVyID0gdGhpcy5nZXRQb3BIYW5kbGVyKCk7XG4gICAgaWYgKHBvcEhhbmRsZXIpIHBvcEhhbmRsZXIuZnJhbWVEaWRQb3AoKTtcblxuICAgIGxldCB7IGZyYW1lcywgZnJhbWUgfSA9IHRoaXM7XG4gICAgZnJhbWVzW2ZyYW1lXSA9IG51bGw7XG4gICAgdGhpcy5mcmFtZSA9IGZyYW1lID09PSAwID8gdW5kZWZpbmVkIDogZnJhbWUgLSAxO1xuICB9XG5cbiAgZ2V0T3BzKCk6IE9wU2VxIHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZXNbdGhpcy5mcmFtZV0ub3BzO1xuICB9XG5cbiAgZ2V0Q3VycmVudCgpOiBPcGNvZGUge1xuICAgIHJldHVybiB0aGlzLmZyYW1lc1t0aGlzLmZyYW1lXS5vcDtcbiAgfVxuXG4gIHNldEN1cnJlbnQob3A6IE9wY29kZSk6IE9wY29kZSB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVzW3RoaXMuZnJhbWVdLm9wID0gb3A7XG4gIH1cblxuICBnZXRPcGVyYW5kKCk6IFBhdGhSZWZlcmVuY2Uge1xuICAgIHJldHVybiB0aGlzLmZyYW1lc1t0aGlzLmZyYW1lXS5vcGVyYW5kO1xuICB9XG5cbiAgc2V0T3BlcmFuZChvcGVyYW5kOiBQYXRoUmVmZXJlbmNlKTogUGF0aFJlZmVyZW5jZSB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVzW3RoaXMuZnJhbWVdLm9wZXJhbmQgPSBvcGVyYW5kO1xuICB9XG5cbiAgZ2V0QXJncygpOiBFdmFsdWF0ZWRBcmdzIHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZXNbdGhpcy5mcmFtZV0uYXJncztcbiAgfVxuXG4gIHNldEFyZ3MoYXJnczogRXZhbHVhdGVkQXJncyk6IEV2YWx1YXRlZEFyZ3Mge1xuICAgIHJldHVybiB0aGlzLmZyYW1lc1t0aGlzLmZyYW1lXS5hcmdzID0gYXJncztcbiAgfVxuXG4gIGdldENvbmRpdGlvbigpOiBDaGFpbmFibGVSZWZlcmVuY2Uge1xuICAgIHJldHVybiB0aGlzLmZyYW1lc1t0aGlzLmZyYW1lXS5jb25kaXRpb247XG4gIH1cblxuICBzZXRDb25kaXRpb24oY29uZGl0aW9uOiBDaGFpbmFibGVSZWZlcmVuY2UpOiBDaGFpbmFibGVSZWZlcmVuY2Uge1xuICAgIHJldHVybiB0aGlzLmZyYW1lc1t0aGlzLmZyYW1lXS5jb25kaXRpb24gPSBjb25kaXRpb247XG4gIH1cblxuICBnZXRJdGVyYXRvcigpOiBMaXN0SXRlcmF0b3Ige1xuICAgIHJldHVybiB0aGlzLmZyYW1lc1t0aGlzLmZyYW1lXS5pdGVyYXRvcjtcbiAgfVxuXG4gIHNldEl0ZXJhdG9yKGl0ZXJhdG9yOiBMaXN0SXRlcmF0b3IpOiBMaXN0SXRlcmF0b3Ige1xuICAgIHJldHVybiB0aGlzLmZyYW1lc1t0aGlzLmZyYW1lXS5pdGVyYXRvciA9IGl0ZXJhdG9yO1xuICB9XG5cbiAgZ2V0S2V5KCk6IEludGVybmVkU3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZXNbdGhpcy5mcmFtZV0ua2V5O1xuICB9XG5cbiAgc2V0S2V5KGtleTogSW50ZXJuZWRTdHJpbmcpOiBJbnRlcm5lZFN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVzW3RoaXMuZnJhbWVdLmtleSA9IGtleTtcbiAgfVxuXG4gIGdldFRlbXBsYXRlcygpOiBEaWN0PFRlbXBsYXRlPiB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVzW3RoaXMuZnJhbWVdLnRlbXBsYXRlcztcbiAgfVxuXG4gIHNldFRlbXBsYXRlcyh0ZW1wbGF0ZXM6IERpY3Q8VGVtcGxhdGU+KTogRGljdDxUZW1wbGF0ZT4ge1xuICAgIHJldHVybiB0aGlzLmZyYW1lc1t0aGlzLmZyYW1lXS50ZW1wbGF0ZXMgPSB0ZW1wbGF0ZXM7XG4gIH1cblxuICBnZXRQb3BIYW5kbGVyKCk6IEZyYW1lRGlkUG9wIHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZXNbdGhpcy5mcmFtZV0ucG9wSGFuZGxlcjtcbiAgfVxuXG4gIHNldFBvcEhhbmRsZXIoaGFuZGxlcjogRnJhbWVEaWRQb3ApOiBGcmFtZURpZFBvcCB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVzW3RoaXMuZnJhbWVdLnBvcEhhbmRsZXIgPSBoYW5kbGVyO1xuICB9XG5cbiAgZ290byhvcDogT3Bjb2RlKSB7XG4gICAgdGhpcy5zZXRDdXJyZW50KG9wKTtcbiAgfVxuXG4gIGhhc09wY29kZXMoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWUgIT09IHVuZGVmaW5lZDtcbiAgfVxuXG4gIG5leHRTdGF0ZW1lbnQoKTogT3Bjb2RlIHtcbiAgICBsZXQgb3AgPSB0aGlzLmZyYW1lc1t0aGlzLmZyYW1lXS5vcDtcbiAgICBsZXQgb3BzID0gdGhpcy5nZXRPcHMoKTtcblxuICAgIGlmIChvcCkge1xuICAgICAgdGhpcy5zZXRDdXJyZW50KG9wcy5uZXh0Tm9kZShvcCkpO1xuICAgICAgcmV0dXJuIG9wO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnBvcCgpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG59XG5cbmVudW0gU2xvdHMge1xuICBPcHMgPSAwLFxuICBDdXJyZW50ID0gMSxcbiAgT3BlcmFuZCA9IDIsXG4gIEFyZ3MgPSAzLFxuICBDb25kaXRpb24gPSA0LFxuICBJdGVyYXRvciA9IDUsXG4gIEtleSA9IDYsXG4gIFRlbXBsYXRlcyA9IDdcbn0iXX0=