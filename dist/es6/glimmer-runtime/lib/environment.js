import { YieldSyntax } from "./syntax/core";
import { NULL_REFERENCE } from './references';
import { ConstReference } from 'glimmer-reference';
import { intern, installGuid } from 'glimmer-util';
export class Scope {
    constructor(parent, references) {
        this.references = references;
        this.parent = parent;
    }
    static root(parent, size = 0) {
        let refs = new Array(size + 1);
        for (let i = 0; i <= size; i++) {
            refs[i] = NULL_REFERENCE;
        }
        return new Scope(parent, refs);
    }
    init({ self }) {
        this.references[0] = self;
        return this;
    }
    getSelf() {
        return this.references[0];
    }
    getSymbol(symbol) {
        return this.references[symbol];
    }
    bindSymbol(symbol, value) {
        this.references[symbol] = value;
    }
    child() {
        return new Scope(this, this.references.slice());
    }
}
export class Environment {
    constructor(dom, meta) {
        this.createdComponents = [];
        this.createdHooks = [];
        this.updatedComponents = [];
        this.updatedHooks = [];
        this.dom = dom;
        this.meta = meta;
    }
    getDOM() { return this.dom; }
    getIdentity(object) {
        return intern(installGuid(object) + '');
    }
    createRootScope(size) {
        return Scope.root(null, size);
    }
    statement(statement) {
        let type = statement.type;
        if (type === 'append') {
            let append = statement;
            let unknown = append.value.type === 'unknown' ? append.value : null;
            let helper = append.value.type === 'helper' ? append.value : null;
            if (unknown && unknown.simplePath() === 'yield') {
                return new YieldSyntax({ args: null });
            }
            else if (helper && helper.ref.simplePath() === 'yield') {
                return new YieldSyntax({ args: helper.args });
            }
        }
        return statement;
    }
    begin() {
        this.createdComponents = [];
        this.createdHooks = [];
        this.updatedComponents = [];
        this.updatedHooks = [];
    }
    didCreate(component, hooks) {
        this.createdComponents.push(component);
        this.createdHooks.push(hooks);
    }
    didUpdate(component, hooks) {
        this.updatedComponents.push(component);
        this.updatedHooks.push(hooks);
    }
    commit() {
        this.createdComponents.forEach((component, i) => {
            let hooks = this.createdHooks[i];
            hooks.didInsertElement(component);
            hooks.didRender(component);
        });
        this.updatedComponents.forEach((component, i) => {
            let hooks = this.updatedHooks[i];
            hooks.didUpdate(component);
            hooks.didRender(component);
        });
    }
    iteratorFor(iterable) {
        let position = 0;
        let len = iterable.value().length;
        return {
            next() {
                if (position >= len)
                    return { done: true, value: undefined };
                position++;
                return {
                    done: false,
                    value: iterable.get(intern("" + (position - 1)))
                };
            }
        };
    }
}
export default Environment;
export function helper(h) {
    return new ConstReference(h);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW52aXJvbm1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnbGltbWVyLXJ1bnRpbWUvbGliL2Vudmlyb25tZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJPQUFPLEVBQ0wsV0FBVyxFQUlaLE1BQU0sZUFBZTtPQUlmLEVBQUUsY0FBYyxFQUFFLE1BQU0sY0FBYztPQVF0QyxFQUVMLGNBQWMsRUFFZixNQUFNLG1CQUFtQjtPQUVuQixFQUdMLE1BQU0sRUFDTixXQUFXLEVBQ1osTUFBTSxjQUFjO0FBSXJCO0lBZ0JFLFlBQVksTUFBYSxFQUFFLFVBQTJCO1FBQ3BELElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7SUFsQkQsT0FBTyxJQUFJLENBQUMsTUFBYSxFQUFFLElBQUksR0FBRyxDQUFDO1FBQ2pDLElBQUksSUFBSSxHQUFvQixJQUFJLEtBQUssQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFaEQsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQy9CLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxjQUFjLENBQUM7UUFDM0IsQ0FBQztRQUVELE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQVlELElBQUksQ0FBQyxFQUFFLElBQUksRUFBMkI7UUFDcEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxPQUFPO1FBQ0wsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELFNBQVMsQ0FBQyxNQUFj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QyxNQUFNLENBQUMsRUFBRSxHQUFHLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ2pELENBQUM7WUFDSixDQUFDO1NBQ0YsQ0FBQztJQUNKLENBQUM7QUFLSCxDQUFDO0FBRUQsZUFBZSxXQUFXLENBQUM7QUFtQjNCLHVCQUF1QixDQUFTO0lBQzlCLE1BQU0sQ0FBQyxJQUFJLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMvQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgWWllbGRTeW50YXgsXG4gIEhlbHBlciBhcyBIZWxwZXJTeW50YXgsXG4gIFVua25vd24sXG4gIEFwcGVuZCxcbn0gZnJvbSBcIi4vc3ludGF4L2NvcmVcIjtcblxuaW1wb3J0IHsgU3RhdGVtZW50U3ludGF4IH0gZnJvbSAnLi9zeW50YXgnO1xuXG5pbXBvcnQgeyBOVUxMX1JFRkVSRU5DRSB9IGZyb20gJy4vcmVmZXJlbmNlcyc7XG5cbmltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgQ29tcG9uZW50SG9va3MsXG4gIENvbXBvbmVudERlZmluaXRpb25cbn0gZnJvbSAnLi9jb21wb25lbnQvaW50ZXJmYWNlcyc7XG5cbmltcG9ydCB7XG4gIFBhdGhSZWZlcmVuY2UsXG4gIENvbnN0UmVmZXJlbmNlLFxuICBNZXRhTG9va3VwXG59IGZyb20gJ2dsaW1tZXItcmVmZXJlbmNlJztcblxuaW1wb3J0IHtcbiAgSGFzR3VpZCxcbiAgSW50ZXJuZWRTdHJpbmcsXG4gIGludGVybixcbiAgaW5zdGFsbEd1aWRcbn0gZnJvbSAnZ2xpbW1lci11dGlsJztcblxuaW1wb3J0IHsgRGljdCB9IGZyb20gJ2dsaW1tZXItdXRpbCc7XG5cbmV4cG9ydCBjbGFzcyBTY29wZSB7XG4gIHN0YXRpYyByb290KHBhcmVudDogU2NvcGUsIHNpemUgPSAwKSB7XG4gICAgbGV0IHJlZnM6IFBhdGhSZWZlcmVuY2VbXSA9IG5ldyBBcnJheShzaXplICsgMSk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBzaXplOyBpKyspIHtcbiAgICAgIHJlZnNbaV0gPSBOVUxMX1JFRkVSRU5DRTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFNjb3BlKHBhcmVudCwgcmVmcyk7XG4gIH1cblxuICBwcml2YXRlIHBhcmVudDogU2NvcGU7XG5cbiAgLy8gdGhlIDB0aCBzbG90IGlzIGBzZWxmYFxuICBwcml2YXRlIHJlZmVyZW5jZXM6IFBhdGhSZWZlcmVuY2VbXTtcblxuICBjb25zdHJ1Y3RvcihwYXJlbnQ6IFNjb3BlLCByZWZlcmVuY2VzOiBQYXRoUmVmZXJlbmNlW10pIHtcbiAgICB0aGlzLnJlZmVyZW5jZXMgPSByZWZlcmVuY2VzO1xuICAgIHRoaXMucGFyZW50ID0gcGFyZW50O1xuICB9XG5cbiAgaW5pdCh7IHNlbGYgfTogeyBzZWxmOiBQYXRoUmVmZXJlbmNlIH0pOiB0aGlzIHtcbiAgICB0aGlzLnJlZmVyZW5jZXNbMF0gPSBzZWxmO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgZ2V0U2VsZigpOiBQYXRoUmVmZXJlbmNlIHtcbiAgICByZXR1cm4gdGhpcy5yZWZlcmVuY2VzWzBdO1xuICB9XG5cbiAgZ2V0U3ltYm9sKHN5bWJvbDogbnVtYmVyKTogUGF0aFJlZmVyZW5jZSB7XG4gICAgcmV0dXJuIHRoaXMucmVmZXJlbmNlc1tzeW1ib2xdO1xuICB9XG5cbiAgYmluZFN5bWJvbChzeW1ib2w6IG51bWJlciwgdmFsdWU6IFBhdGhSZWZlcmVuY2UpIHtcbiAgICB0aGlzLnJlZmVyZW5jZXNbc3ltYm9sXSA9IHZhbHVlO1xuICB9XG5cbiAgY2hpbGQoKSB7XG4gICAgcmV0dXJuIG5ldyBTY29wZSh0aGlzLCB0aGlzLnJlZmVyZW5jZXMuc2xpY2UoKSk7XG4gIH1cbn1cblxuaW1wb3J0IERPTUhlbHBlciBmcm9tICcuL2RvbSc7XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBFbnZpcm9ubWVudCB7XG4gIHByb3RlY3RlZCBkb206IERPTUhlbHBlcjtcbiAgcHJvdGVjdGVkIG1ldGE6IE1ldGFMb29rdXA7XG4gIHByaXZhdGUgY3JlYXRlZENvbXBvbmVudHM6IENvbXBvbmVudFtdID0gW107XG4gIHByaXZhdGUgY3JlYXRlZEhvb2tzOiBDb21wb25lbnRIb29rc1tdID0gW107XG4gIHByaXZhdGUgdXBkYXRlZENvbXBvbmVudHM6IENvbXBvbmVudFtdID0gW107XG4gIHByaXZhdGUgdXBkYXRlZEhvb2tzOiBDb21wb25lbnRIb29rc1tdID0gW107XG5cbiAgY29uc3RydWN0b3IoZG9tOiBET01IZWxwZXIsIG1ldGE6IE1ldGFMb29rdXApIHtcbiAgICB0aGlzLmRvbSA9IGRvbTtcbiAgICB0aGlzLm1ldGEgPSBtZXRhO1xuICB9XG5cbiAgZ2V0RE9NKCk6IERPTUhlbHBlciB7IHJldHVybiB0aGlzLmRvbTsgfVxuXG4gIGdldElkZW50aXR5KG9iamVjdDogSGFzR3VpZCk6IEludGVybmVkU3RyaW5nIHtcbiAgICByZXR1cm4gaW50ZXJuKGluc3RhbGxHdWlkKG9iamVjdCkgKyAnJyk7XG4gIH1cblxuICBjcmVhdGVSb290U2NvcGUoc2l6ZTogbnVtYmVyKTogU2NvcGUge1xuICAgIHJldHVybiBTY29wZS5yb290KG51bGwsIHNpemUpO1xuICB9XG5cbiAgc3RhdGVtZW50KHN0YXRlbWVudDogU3RhdGVtZW50U3ludGF4KTogU3RhdGVtZW50U3ludGF4IHtcbiAgICBsZXQgdHlwZSA9IHN0YXRlbWVudC50eXBlO1xuXG4gICAgaWYgKHR5cGUgPT09ICdhcHBlbmQnKSB7XG4gICAgICBsZXQgYXBwZW5kID0gPEFwcGVuZD5zdGF0ZW1lbnQ7XG4gICAgICBsZXQgdW5rbm93biA9IGFwcGVuZC52YWx1ZS50eXBlID09PSAndW5rbm93bicgPyA8VW5rbm93bj5hcHBlbmQudmFsdWUgOiBudWxsO1xuICAgICAgbGV0IGhlbHBlciA9IGFwcGVuZC52YWx1ZS50eXBlID09PSAnaGVscGVyJyA/IDxIZWxwZXJTeW50YXg+YXBwZW5kLnZhbHVlIDogbnVsbDtcblxuICAgICAgaWYgKHVua25vd24gJiYgdW5rbm93bi5zaW1wbGVQYXRoKCkgPT09ICd5aWVsZCcpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBZaWVsZFN5bnRheCh7IGFyZ3M6IG51bGwgfSk7XG4gICAgICB9IGVsc2UgaWYgKGhlbHBlciAmJiBoZWxwZXIucmVmLnNpbXBsZVBhdGgoKSA9PT0gJ3lpZWxkJykge1xuICAgICAgICByZXR1cm4gbmV3IFlpZWxkU3ludGF4KHsgYXJnczogaGVscGVyLmFyZ3MgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHN0YXRlbWVudDtcbiAgfVxuXG4gIGJlZ2luKCkge1xuICAgIHRoaXMuY3JlYXRlZENvbXBvbmVudHMgPSBbXTtcbiAgICB0aGlzLmNyZWF0ZWRIb29rcyA9IFtdO1xuICAgIHRoaXMudXBkYXRlZENvbXBvbmVudHMgPSBbXTtcbiAgICB0aGlzLnVwZGF0ZWRIb29rcyA9IFtdO1xuICB9XG5cbiAgZGlkQ3JlYXRlKGNvbXBvbmVudDogQ29tcG9uZW50LCBob29rczogQ29tcG9uZW50SG9va3MpIHtcbiAgICB0aGlzLmNyZWF0ZWRDb21wb25lbnRzLnB1c2goY29tcG9uZW50KTtcbiAgICB0aGlzLmNyZWF0ZWRIb29rcy5wdXNoKGhvb2tzKTtcbiAgfVxuXG4gIGRpZFVwZGF0ZShjb21wb25lbnQ6IENvbXBvbmVudCwgaG9va3M6IENvbXBvbmVudEhvb2tzKSB7XG4gICAgdGhpcy51cGRhdGVkQ29tcG9uZW50cy5wdXNoKGNvbXBvbmVudCk7XG4gICAgdGhpcy51cGRhdGVkSG9va3MucHVzaChob29rcyk7XG4gIH1cblxuICBjb21taXQoKSB7XG4gICAgdGhpcy5jcmVhdGVkQ29tcG9uZW50cy5mb3JFYWNoKChjb21wb25lbnQsIGkpID0+IHtcbiAgICAgIGxldCBob29rcyA9IHRoaXMuY3JlYXRlZEhvb2tzW2ldO1xuICAgICAgaG9va3MuZGlkSW5zZXJ0RWxlbWVudChjb21wb25lbnQpO1xuICAgICAgaG9va3MuZGlkUmVuZGVyKGNvbXBvbmVudCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnVwZGF0ZWRDb21wb25lbnRzLmZvckVhY2goKGNvbXBvbmVudCwgaSkgPT4ge1xuICAgICAgbGV0IGhvb2tzID0gdGhpcy51cGRhdGVkSG9va3NbaV07XG4gICAgICBob29rcy5kaWRVcGRhdGUoY29tcG9uZW50KTtcbiAgICAgIGhvb2tzLmRpZFJlbmRlcihjb21wb25lbnQpO1xuICAgIH0pO1xuICB9XG5cbiAgaXRlcmF0b3JGb3IoaXRlcmFibGU6IFBhdGhSZWZlcmVuY2UpIHtcbiAgICBsZXQgcG9zaXRpb24gPSAwO1xuICAgIGxldCBsZW4gPSBpdGVyYWJsZS52YWx1ZSgpLmxlbmd0aDtcblxuICAgIHJldHVybiB7XG4gICAgICBuZXh0KCkge1xuICAgICAgICBpZiAocG9zaXRpb24gPj0gbGVuKSByZXR1cm4geyBkb25lOiB0cnVlLCB2YWx1ZTogdW5kZWZpbmVkIH07XG5cbiAgICAgICAgcG9zaXRpb24rKztcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGRvbmU6IGZhbHNlLFxuICAgICAgICAgIHZhbHVlOiBpdGVyYWJsZS5nZXQoaW50ZXJuKFwiXCIgKyAocG9zaXRpb24gLSAxKSkpXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIGFic3RyYWN0IGhhc0hlbHBlcihoZWxwZXJOYW1lOiBJbnRlcm5lZFN0cmluZ1tdKTogYm9vbGVhbjtcbiAgYWJzdHJhY3QgbG9va3VwSGVscGVyKGhlbHBlck5hbWU6IEludGVybmVkU3RyaW5nW10pOiBIZWxwZXI7XG4gIGFic3RyYWN0IGdldENvbXBvbmVudERlZmluaXRpb24odGFnTmFtZTogSW50ZXJuZWRTdHJpbmdbXSwgc3ludGF4OiBTdGF0ZW1lbnRTeW50YXgpOiBDb21wb25lbnREZWZpbml0aW9uO1xufVxuXG5leHBvcnQgZGVmYXVsdCBFbnZpcm9ubWVudDtcblxuLy8gVFMgZG9lcyBub3QgYWxsb3cgdXMgdG8gdXNlIGNvbXB1dGVkIHByb3BlcnRpZXMgZm9yIHRoaXMsIHNvIGlubGluaW5nIGZvciBub3dcbi8vIGltcG9ydCB7IFRSVVNURURfU1RSSU5HIH0gZnJvbSAnLi9zeW1ib2xzJztcblxuaW50ZXJmYWNlIFNhZmVTdHJpbmcge1xuICBcInRydXN0ZWQgc3RyaW5nIFtpZD03ZDEwYzEzZC1jZGY1LTQ1ZjQtODg1OS1iMDljZTE2NTE3YzJdXCI6IGJvb2xlYW47IC8vIHRydWVcbiAgc3RyaW5nOiBzdHJpbmc7XG59XG5cbmV4cG9ydCB0eXBlIEluc2VydGlvbiA9IHN0cmluZyB8IFNhZmVTdHJpbmcgfCBOb2RlO1xuXG50eXBlIFBvc2l0aW9uYWxBcmd1bWVudHMgPSBhbnlbXTtcbnR5cGUgS2V5d29yZEFyZ3VtZW50cyA9IERpY3Q8YW55PjtcblxuZXhwb3J0IGludGVyZmFjZSBIZWxwZXIge1xuICAocG9zaXRpb25hbDogUG9zaXRpb25hbEFyZ3VtZW50cywgbmFtZWQ6IEtleXdvcmRBcmd1bWVudHMsIG9wdGlvbnM6IE9iamVjdCk6IEluc2VydGlvbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhlbHBlcihoOiBIZWxwZXIpOiBDb25zdFJlZmVyZW5jZTxIZWxwZXI+IHtcbiAgcmV0dXJuIG5ldyBDb25zdFJlZmVyZW5jZShoKTtcbn0iXX0=