import { ListSlice, dict, assign } from 'glimmer-util';
class VMOpcode {
    constructor() {
        this.next = null;
        this.prev = null;
    }
}
class VMUpdatingOpcode {
    constructor() {
        this.next = null;
        this.prev = null;
    }
}
export class PushChildScopeOpcode extends VMOpcode {
    constructor(...args) {
        super(...args);
        this.type = "push-child-scope";
    }
    evaluate(vm) {
        vm.pushChildScope();
    }
}
export class PopScopeOpcode extends VMOpcode {
    constructor(...args) {
        super(...args);
        this.type = "pop-scope";
    }
    evaluate(vm) {
        vm.popScope();
    }
}
export class PutValue extends VMOpcode {
    constructor(expression) {
        super();
        this.type = "put-value";
        this.expression = expression;
    }
    evaluate(vm) {
        vm.evaluateOperand(this.expression);
    }
}
export class PutArgsOpcode extends VMOpcode {
    constructor(args) {
        super();
        this.type = "put-args";
        this.args = args;
    }
    evaluate(vm) {
        vm.evaluateArgs(this.args);
    }
}
export class BindArgsOpcode extends VMOpcode {
    constructor(template) {
        super();
        this.type = "bind-args";
        this.positional = [0, 0, 0, 0, 0, 0, 0, 0, 0];
        if (template.locals) {
            template.locals.forEach((name, i) => {
                this.positional[i] = template.symbolTable.get(name);
            });
        }
        if (template.isTop() && template.named) {
            this.named = template.named.reduce((obj, name) => assign(obj, { [name]: template.symbolTable.get(name) }), dict());
        }
        else {
            this.named = dict();
        }
    }
    evaluate(vm) {
        vm.bindArgs(this.positional, this.named);
    }
}
export class EnterOpcode extends VMOpcode {
    constructor(begin, end) {
        super();
        this.type = "enter";
        this.slice = new ListSlice(begin, end);
    }
    evaluate(vm) {
        vm.enter(this.slice);
    }
}
export class ExitOpcode extends VMOpcode {
    constructor(...args) {
        super(...args);
        this.type = "exit";
    }
    evaluate(vm) {
        vm.exit();
    }
}
export class NoopOpcode extends VMOpcode {
    constructor(label) {
        super();
        this.type = "noop";
        this.label = null;
        if (label)
            this.label = label;
    }
    evaluate(vm) {
    }
}
export class EvaluateOpcode extends VMOpcode {
    constructor(template) {
        super();
        this.type = "evaluate";
        this.template = template;
    }
    evaluate(vm) {
        this.template.compile(vm.env);
        vm.pushFrame(this.template.ops, vm.frame.getArgs());
    }
}
export class TestOpcode extends VMOpcode {
    constructor(...args) {
        super(...args);
        this.type = "test";
    }
    evaluate(vm) {
        vm.frame.setCondition(vm.frame.getOperand());
    }
}
export class JumpOpcode extends VMOpcode {
    constructor(target) {
        super();
        this.type = "jump";
        this.target = target;
    }
    evaluate(vm) {
        vm.goto(this.target);
    }
}
export class JumpIfOpcode extends JumpOpcode {
    constructor(...args) {
        super(...args);
        this.type = "jump-if";
    }
    evaluate(vm) {
        let reference = vm.frame.getCondition();
        let value = reference.value();
        if (value) {
            super.evaluate(vm);
            vm.updateWith(new Assert(reference));
        }
        else {
            vm.updateWith(new AssertFalse(reference));
        }
    }
}
export class JumpUnlessOpcode extends JumpOpcode {
    constructor(...args) {
        super(...args);
        this.type = "jump-unless";
    }
    evaluate(vm) {
        let reference = vm.frame.getCondition();
        let value = reference.value();
        if (value) {
            vm.updateWith(new Assert(reference));
        }
        else {
            super.evaluate(vm);
            vm.updateWith(new AssertFalse(reference));
        }
    }
}
export class Assert extends VMUpdatingOpcode {
    constructor(reference) {
        super();
        this.type = "assert";
        this.reference = reference;
    }
    evaluate(vm) {
        if (!this.reference.value()) {
            vm.throw();
        }
    }
}
export class AssertFalse extends VMUpdatingOpcode {
    constructor(reference) {
        super();
        this.type = "assert";
        this.reference = reference;
    }
    evaluate(vm) {
        if (this.reference.value()) {
            vm.throw();
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnbGltbWVyLXJ1bnRpbWUvbGliL2NvbXBpbGVkL29wY29kZXMvdm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ik9BTU8sRUFBRSxTQUFTLEVBQWUsSUFBSSxFQUFFLE1BQU0sRUFBRSxNQUFNLGNBQWM7QUFHbkU7SUFBQTtRQUVTLFNBQUksR0FBRyxJQUFJLENBQUM7UUFDWixTQUFJLEdBQUcsSUFBSSxDQUFDO0lBR3JCLENBQUM7QUFBRCxDQUFDO0FBRUQ7SUFBQTtRQUVTLFNBQUksR0FBRyxJQUFJLENBQUM7UUFDWixTQUFJLEdBQUcsSUFBSSxDQUFDO0lBR3JCLENBQUM7QUFBRCxDQUFDO0FBRUQsMENBQTBDLFFBQVE7SUFBbEQ7UUFBMEMsZUFBUTtRQUN6QyxTQUFJLEdBQUcsa0JBQWtCLENBQUM7SUFLbkMsQ0FBQztJQUhDLFFBQVEsQ0FBQyxFQUFNO1FBQ2IsRUFBRSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3RCLENBQUM7QUFDSCxDQUFDO0FBRUQsb0NBQW9DLFFBQVE7SUFBNUM7UUFBb0MsZUFBUTtRQUNuQyxTQUFJLEdBQUcsV0FBVyxDQUFDO0lBSzVCLENBQUM7SUFIQyxRQUFRLENBQUMsRUFBTTtRQUNiLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNoQixDQUFDO0FBQ0gsQ0FBQztBQUVELDhCQUE4QixRQUFRO0lBSXBDLFlBQVksVUFBOEI7UUFDeEMsT0FBTyxDQUFDO1FBSkgsU0FBSSxHQUFHLFdBQVcsQ0FBQztRQUt4QixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztJQUMvQixDQUFDO0lBRUQsUUFBUSxDQUFDLEVBQU07UUFDYixFQUFFLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN0QyxDQUFDO0FBQ0gsQ0FBQztBQUVELG1DQUFtQyxRQUFRO0lBS3pDLFlBQVksSUFBa0I7UUFDNUIsT0FBTyxDQUFDO1FBTEgsU0FBSSxHQUFH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Q3ZDLE9BQU8sQ0FBQztRQUxILFNBQUksR0FBRyxRQUFRLENBQUM7UUFNckIsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7SUFDN0IsQ0FBQztJQUVELFFBQVEsQ0FBQyxFQUFjO1FBQ3JCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzNCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNiLENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT3Bjb2RlLCBVcGRhdGluZ09wY29kZSB9IGZyb20gJy4uLy4uL29wY29kZXMnO1xuaW1wb3J0IHsgQ29tcGlsZWRFeHByZXNzaW9uIH0gZnJvbSAnLi4vZXhwcmVzc2lvbnMnO1xuaW1wb3J0IHsgQ29tcGlsZWRBcmdzIH0gZnJvbSAnLi4vZXhwcmVzc2lvbnMvYXJncyc7XG5pbXBvcnQgeyBWTSwgVXBkYXRpbmdWTSB9IGZyb20gJy4uLy4uL3ZtJztcbmltcG9ydCB7IFJhd1RlbXBsYXRlIH0gZnJvbSAnLi4vLi4vY29tcGlsZXInO1xuaW1wb3J0IHsgUmFuZ2UgfSBmcm9tICcuLi8uLi91dGlscyc7XG5pbXBvcnQgeyBMaXN0U2xpY2UsIFNsaWNlLCBEaWN0LCBkaWN0LCBhc3NpZ24gfSBmcm9tICdnbGltbWVyLXV0aWwnO1xuaW1wb3J0IHsgQ2hhaW5hYmxlUmVmZXJlbmNlIH0gZnJvbSAnZ2xpbW1lci1yZWZlcmVuY2UnO1xuXG5hYnN0cmFjdCBjbGFzcyBWTU9wY29kZSBpbXBsZW1lbnRzIE9wY29kZSB7XG4gIHB1YmxpYyB0eXBlOiBzdHJpbmc7XG4gIHB1YmxpYyBuZXh0ID0gbnVsbDtcbiAgcHVibGljIHByZXYgPSBudWxsO1xuXG4gIGFic3RyYWN0IGV2YWx1YXRlKHZtOiBWTSk7XG59XG5cbmFic3RyYWN0IGNsYXNzIFZNVXBkYXRpbmdPcGNvZGUgaW1wbGVtZW50cyBVcGRhdGluZ09wY29kZSB7XG4gIHB1YmxpYyB0eXBlOiBzdHJpbmc7XG4gIHB1YmxpYyBuZXh0ID0gbnVsbDtcbiAgcHVibGljIHByZXYgPSBudWxsO1xuXG4gIGFic3RyYWN0IGV2YWx1YXRlKHZtOiBVcGRhdGluZ1ZNKTtcbn1cblxuZXhwb3J0IGNsYXNzIFB1c2hDaGlsZFNjb3BlT3Bjb2RlIGV4dGVuZHMgVk1PcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9IFwicHVzaC1jaGlsZC1zY29wZVwiO1xuXG4gIGV2YWx1YXRlKHZtOiBWTSkge1xuICAgIHZtLnB1c2hDaGlsZFNjb3BlKCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFBvcFNjb3BlT3Bjb2RlIGV4dGVuZHMgVk1PcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9IFwicG9wLXNjb3BlXCI7XG5cbiAgZXZhbHVhdGUodm06IFZNKSB7XG4gICAgdm0ucG9wU2NvcGUoKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUHV0VmFsdWUgZXh0ZW5kcyBWTU9wY29kZSB7XG4gIHB1YmxpYyB0eXBlID0gXCJwdXQtdmFsdWVcIjtcbiAgcHJpdmF0ZSBleHByZXNzaW9uOiBDb21waWxlZEV4cHJlc3Npb247XG5cbiAgY29uc3RydWN0b3IoZXhwcmVzc2lvbjogQ29tcGlsZWRFeHByZXNzaW9uKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmV4cHJlc3Npb24gPSBleHByZXNzaW9uO1xuICB9XG5cbiAgZXZhbHVhdGUodm06IFZNKSB7XG4gICAgdm0uZXZhbHVhdGVPcGVyYW5kKHRoaXMuZXhwcmVzc2lvbik7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFB1dEFyZ3NPcGNvZGUgZXh0ZW5kcyBWTU9wY29kZSB7XG4gIHB1YmxpYyB0eXBlID0gXCJwdXQtYXJnc1wiO1xuXG4gIHByaXZhdGUgYXJnczogQ29tcGlsZWRBcmdzO1xuXG4gIGNvbnN0cnVjdG9yKGFyZ3M6IENvbXBpbGVkQXJncykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5hcmdzID0gYXJncztcbiAgfVxuXG4gIGV2YWx1YXRlKHZtOiBWTSkge1xuICAgIHZtLmV2YWx1YXRlQXJncyh0aGlzLmFyZ3MpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBCaW5kQXJnc09wY29kZSBleHRlbmRzIFZNT3Bjb2RlIHtcbiAgcHVibGljIHR5cGUgPSBcImJpbmQtYXJnc1wiO1xuXG4gIHByaXZhdGUgcG9zaXRpb25hbDogbnVtYmVyW10gPSBbMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMF07XG4gIHByaXZhdGUgbmFtZWQ6IERpY3Q8bnVtYmVyPjtcblxuICBjb25zdHJ1Y3Rvcih0ZW1wbGF0ZTogUmF3VGVtcGxhdGUpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgaWYgKHRlbXBsYXRlLmxvY2Fscykge1xuICAgICAgdGVtcGxhdGUubG9jYWxzLmZvckVhY2goKG5hbWUsIGkpID0+IHtcbiAgICAgICAgdGhpcy5wb3NpdGlvbmFsWzxudW1iZXI+aV0gPSB0ZW1wbGF0ZS5zeW1ib2xUYWJsZS5nZXQobmFtZSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAodGVtcGxhdGUuaXNUb3AoKSAmJiB0ZW1wbGF0ZS5uYW1lZCkge1xuICAgICAgdGhpcy5uYW1lZCA9IHRlbXBsYXRlLm5hbWVkLnJlZHVjZShcbiAgICAgICAgKG9iaiwgbmFtZSkgPT4gYXNzaWduKG9iaiwgeyBbPHN0cmluZz5uYW1lXTogdGVtcGxhdGUuc3ltYm9sVGFibGUuZ2V0KG5hbWUpIH0pLFxuICAgICAgICBkaWN0PG51bWJlcj4oKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5uYW1lZCA9IGRpY3Q8bnVtYmVyPigpO1xuICAgIH1cbiAgfVxuXG4gIGV2YWx1YXRlKHZtOiBWTSkge1xuICAgIHZtLmJpbmRBcmdzKHRoaXMucG9zaXRpb25hbCwgdGhpcy5uYW1lZCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEVudGVyT3Bjb2RlIGV4dGVuZHMgVk1PcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9IFwiZW50ZXJcIjtcbiAgcHJpdmF0ZSBzbGljZTogU2xpY2U8T3Bjb2RlPjtcblxuICBjb25zdHJ1Y3RvcihiZWdpbjogTm9vcE9wY29kZSwgZW5kOiBOb29wT3Bjb2RlKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnNsaWNlID0gbmV3IExpc3RTbGljZShiZWdpbiwgZW5kKTtcbiAgfVxuXG4gIGV2YWx1YXRlKHZtOiBWTSkge1xuICAgIHZtLmVudGVyKHRoaXMuc2xpY2UpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBFeGl0T3Bjb2RlIGV4dGVuZHMgVk1PcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9IFwiZXhpdFwiO1xuXG4gIGV2YWx1YXRlKHZtOiBWTSkge1xuICAgIHZtLmV4aXQoKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgTm9vcE9wY29kZSBleHRlbmRzIFZNT3Bjb2RlIHtcbiAgcHVibGljIHR5cGUgPSBcIm5vb3BcIjtcblxuICBwdWJsaWMgbGFiZWw6IHN0cmluZyA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IobGFiZWw/OiBzdHJpbmcpIHtcbiAgICBzdXBlcigpO1xuICAgIGlmIChsYWJlbCkgdGhpcy5sYWJlbCA9IGxhYmVsO1xuICB9XG5cbiAgZXZhbHVhdGUodm06IFZNKSB7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEV2YWx1YXRlT3Bjb2RlIGV4dGVuZHMgVk1PcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9IFwiZXZhbHVhdGVcIjtcbiAgcHJpdmF0ZSB0ZW1wbGF0ZTogUmF3VGVtcGxhdGU7XG5cbiAgY29uc3RydWN0b3IodGVtcGxhdGU6IFJhd1RlbXBsYXRlKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7XG4gIH1cblxuICBldmFsdWF0ZSh2bTogVk0pIHtcbiAgICB0aGlzLnRlbXBsYXRlLmNvbXBpbGUodm0uZW52KTtcbiAgICB2bS5wdXNoRnJhbWUodGhpcy50ZW1wbGF0ZS5vcHMsIHZtLmZyYW1lLmdldEFyZ3MoKSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFRlc3RPcGNvZGUgZXh0ZW5kcyBWTU9wY29kZSB7XG4gIHB1YmxpYyB0eXBlID0gXCJ0ZXN0XCI7XG5cbiAgZXZhbHVhdGUodm06IFZNKSB7XG4gICAgdm0uZnJhbWUuc2V0Q29uZGl0aW9uKHZtLmZyYW1lLmdldE9wZXJhbmQoKSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEp1bXBPcGNvZGUgZXh0ZW5kcyBWTU9wY29kZSB7XG4gIHB1YmxpYyB0eXBlID0gXCJqdW1wXCI7XG5cbiAgcHVibGljIHRhcmdldDogTm9vcE9wY29kZTtcblxuICBjb25zdHJ1Y3Rvcih0YXJnZXQ6IE5vb3BPcGNvZGUpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0O1xuICB9XG5cbiAgZXZhbHVhdGUodm06IFZNKSB7XG4gICAgdm0uZ290byh0aGlzLnRhcmdldClcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgSnVtcElmT3Bjb2RlIGV4dGVuZHMgSnVtcE9wY29kZSB7XG4gIHB1YmxpYyB0eXBlID0gXCJqdW1wLWlmXCI7XG5cbiAgZXZhbHVhdGUodm06IFZNKSB7XG4gICAgbGV0IHJlZmVyZW5jZSA9IHZtLmZyYW1lLmdldENvbmRpdGlvbigpO1xuICAgIGxldCB2YWx1ZSA9IHJlZmVyZW5jZS52YWx1ZSgpO1xuXG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICBzdXBlci5ldmFsdWF0ZSh2bSk7XG4gICAgICB2bS51cGRhdGVXaXRoKG5ldyBBc3NlcnQocmVmZXJlbmNlKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydEZhbHNlKHJlZmVyZW5jZSkpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgSnVtcFVubGVzc09wY29kZSBleHRlbmRzIEp1bXBPcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9IFwianVtcC11bmxlc3NcIjtcblxuICBldmFsdWF0ZSh2bTogVk0pIHtcbiAgICBsZXQgcmVmZXJlbmNlID0gdm0uZnJhbWUuZ2V0Q29uZGl0aW9uKCk7XG4gICAgbGV0IHZhbHVlID0gcmVmZXJlbmNlLnZhbHVlKCk7XG5cbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydChyZWZlcmVuY2UpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3VwZXIuZXZhbHVhdGUodm0pO1xuICAgICAgdm0udXBkYXRlV2l0aChuZXcgQXNzZXJ0RmFsc2UocmVmZXJlbmNlKSk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBBc3NlcnQgZXh0ZW5kcyBWTVVwZGF0aW5nT3Bjb2RlIHtcbiAgcHVibGljIHR5cGUgPSBcImFzc2VydFwiO1xuXG4gIHByaXZhdGUgcmVmZXJlbmNlOiBDaGFpbmFibGVSZWZlcmVuY2U7XG5cbiAgY29uc3RydWN0b3IocmVmZXJlbmNlOiBDaGFpbmFibGVSZWZlcmVuY2UpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMucmVmZXJlbmNlID0gcmVmZXJlbmNlO1xuICB9XG5cbiAgZXZhbHVhdGUodm06IFVwZGF0aW5nVk0pIHtcbiAgICBpZiAoIXRoaXMucmVmZXJlbmNlLnZhbHVlKCkpIHtcbiAgICAgIHZtLnRocm93KCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBBc3NlcnRGYWxzZSBleHRlbmRzIFZNVXBkYXRpbmdPcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9IFwiYXNzZXJ0XCI7XG5cbiAgcHJpdmF0ZSByZWZlcmVuY2U6IENoYWluYWJsZVJlZmVyZW5jZTtcblxuICBjb25zdHJ1Y3RvcihyZWZlcmVuY2U6IENoYWluYWJsZVJlZmVyZW5jZSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5yZWZlcmVuY2UgPSByZWZlcmVuY2U7XG4gIH1cblxuICBldmFsdWF0ZSh2bTogVXBkYXRpbmdWTSkge1xuICAgIGlmICh0aGlzLnJlZmVyZW5jZS52YWx1ZSgpKSB7XG4gICAgICB2bS50aHJvdygpO1xuICAgIH1cbiAgfVxufVxuIl19